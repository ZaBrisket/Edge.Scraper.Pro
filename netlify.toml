[build]
  # Changed from "public" to "out" for Next.js static export
  publish = "out"
  functions = "netlify/functions"
  # Changed from "npm run build" to build Next.js application
  command = "npm run next:build"

[build.environment]
  NODE_VERSION = "18"
  NPM_FLAGS = "--production=false"
  HTTP_DEADLINE_MS = "30000"
  NODE_OPTIONS = "--max-old-space-size=4096"
  NPM_CONFIG_CACHE = "/tmp/.npm"

[functions]
  node_bundler = "esbuild"
  included_files = ["prisma/**/*", "src/**/*", "schemas/**/*"]
  external_node_modules = ["aws-sdk"]
  timeout = 30

# Proxy API routes to Netlify Functions
[[redirects]]
  from = "/api/fetch-url"
  to = "/.netlify/functions/fetch-url"
  status = 200

[[redirects]]
  # Temporary mapping for deprecated schema endpoint; returns 410
  from = "/api/get-schema"
  to = "/.netlify/functions/get-schema"
  status = 200

# Authentication API Routes
[[redirects]]
  from = "/api/auth/login"
  to = "/.netlify/functions/auth-login"
  status = 200

[[redirects]]
  from = "/api/auth/register"
  to = "/.netlify/functions/auth-register"
  status = 200

[[redirects]]
  from = "/api/auth/verify"
  to = "/.netlify/functions/auth-verify"
  status = 200

# Target List Formatter API Routes
[[redirects]]
  from = "/api/uploads/presign"
  to = "/.netlify/functions/uploads-presign"
  status = 200

[[redirects]]
  from = "/api/uploads/commit"
  to = "/.netlify/functions/uploads-commit"
  status = 200

[[redirects]]
  from = "/api/templates"
  to = "/.netlify/functions/templates"
  status = 200

[[redirects]]
  from = "/api/preview"
  to = "/.netlify/functions/preview"
  status = 200

[[redirects]]
  from = "/api/health"
  to = "/.netlify/functions/health"
  status = 200

[[redirects]]
  from = "/api/jobs/export"
  to = "/.netlify/functions/jobs-export"
  status = 200

[[redirects]]
  from = "/api/jobs/*"
  to = "/.netlify/functions/jobs-status"
  status = 200

[[redirects]]
  from = "/api/artifacts/*/signed-url"
  to = "/.netlify/functions/artifacts-download"
  status = 200

# API Routes for Next.js application
[[redirects]]
  from = "/api/scrape/*"
  to = "/.netlify/functions/:splat"
  status = 200

[[redirects]]
  from = "/api/tasks/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Security headers for all pages
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains"

# CORS headers for SPA
[[headers]]
  for = "/api/*"
  [headers.values]
    Access-Control-Allow-Origin = "https://your-spa-domain.netlify.app"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization, x-correlation-id"
    Access-Control-Max-Age = "86400"

# Cache policy for large batches
[[headers]]
  for = "/api/jobs/*"
  [headers.values]
    Cache-Control = "public, max-age=300"
    X-Content-Type-Options = "nosniff"

# Static assets caching
[[headers]]
  for = "/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# API rate limiting headers
[[headers]]
  for = "/api/fetch-url"
  [headers.values]
    X-RateLimit-Limit = "100"
    X-RateLimit-Remaining = "99"
    X-RateLimit-Reset = "1640995200"
