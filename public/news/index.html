<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeScraperPro — News Scraper</title>
    <link rel="stylesheet" href="/assets/css/brutalist.css">
</head>
<body data-mode="news">
    <div class="container">
        <div data-component="navigation" data-active="news"></div>
        <div data-component="error" id="globalError"></div>

        <main>
            <h1>News Article Scraper</h1>
            <p class="lede">Paste or upload URLs to extract article content, metadata, and images for newsroom workflows.</p>

            <noscript>
                <div class="section">
                    JavaScript powers batch extraction. Upload TXT or JSON files directly via the API if scripting is disabled.
                </div>
            </noscript>

            <section class="section">
                <h2>URL Intake</h2>
                <div class="dropzone" id="dropzone">
                    <div class="dropzone-text">Drop files here</div>
                    <div class="dropzone-subtext">TXT (one URL per line) or JSON • Maximum 1,500 URLs</div>
                    <button id="selectFilesBtn" type="button">Select Files</button>
                    <input type="file" id="fileInput" accept=".txt,.json" multiple>
                </div>

                <div class="field">
                    <label for="urlInput">URLs</label>
                    <textarea id="urlInput" rows="10" placeholder="Paste URLs here, one per line. Lines starting with # are ignored."></textarea>
                    <div class="help">Enter up to 1,500 URLs. Processing time ~1.5 seconds per URL.</div>
                </div>
            </section>

            <section class="section">
                <h2>Extraction Settings</h2>
                <div class="grid">
                    <div class="field">
                        <label>Extraction Mode</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="extractContent" checked> Extract full content</label>
                            <label><input type="checkbox" id="extractImages"> Extract images</label>
                            <label><input type="checkbox" id="extractMeta"> Extract metadata</label>
                            <label><input type="checkbox" id="sportsMode"> Sports statistics mode</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Export Format</label>
                        <div class="radio-group">
                            <label><input type="radio" name="format" value="jsonl" checked> JSON Lines</label>
                            <label><input type="radio" name="format" value="csv"> CSV</label>
                            <label><input type="radio" name="format" value="txt"> Plain Text</label>
                            <label><input type="radio" name="format" value="structured"> Structured JSON</label>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Performance Controls</h2>
                <div class="grid">
                    <div class="field">
                        <label for="concurrency">Concurrent Requests</label>
                        <input type="number" id="concurrency" value="3" min="1" max="20">
                        <div class="help">Keep 2–4 to avoid WAF/rate limiting.</div>
                    </div>
                    <div class="field">
                        <label for="timeout">Timeout (seconds)</label>
                        <input type="number" id="timeout" value="12" min="5" max="60">
                        <div class="help">Maximum time to wait for each URL.</div>
                    </div>
                    <div class="field">
                        <label for="retries">Max Retries</label>
                        <input type="number" id="retries" value="2" min="0" max="10">
                        <div class="help">Number of retry attempts for failed requests.</div>
                    </div>
                    <div class="field">
                        <label for="delay">Delay Between Requests (ms)</label>
                        <input type="number" id="delay" value="350" min="0" max="5000">
                        <div class="help">Use 300–500ms to smooth bursts.</div>
                    </div>
                </div>
            </section>

            <section class="section">
                <button id="startButton">Start Extraction</button>
            </section>

            <div class="progress" id="progress">
                <div class="progress-text">
                    Processing: <span id="progressCount">0</span> / <span id="progressTotal">0</span>
                </div>
                <div>
                    Elapsed: <span id="elapsed">0s</span> • Remaining: <span id="remaining">calculating...</span>
                </div>
            </div>

            <div class="spinner" id="spinner"></div>

            <div class="results" id="results">
                <div class="results-header">
                    <div>
                        <div class="stat-value" id="statSuccess">0</div>
                        <div class="stat-label">Success</div>
                    </div>
                    <div>
                        <div class="stat-value" id="statFailed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div>
                        <div class="stat-value" id="statTime">0s</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>

                <button id="exportButton">Export Results</button>

                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>

                <div class="results-output" id="resultsOutput"></div>
            </div>

            <section class="ma-section">
                <div class="ma-header">
                    <div>
                        <div class="ma-title">M&amp;A News Scraper</div>
                        <p>Discover deal activity from trusted wires with automated confidence scoring.</p>
                    </div>
                    <span class="ma-badge">Beta</span>
                </div>

                <div class="ma-controls">
                    <div class="ma-control-group">
                        <div class="ma-control-label">News Sources</div>
                        <div class="ma-checkbox-group">
                            <label><input type="checkbox" name="ma-source" value="businesswire" checked> Business Wire</label>
                            <label><input type="checkbox" name="ma-source" value="prnewswire" checked> PR Newswire</label>
                            <label><input type="checkbox" name="ma-source" value="globenewswire"> GlobeNewswire</label>
                            <label><input type="checkbox" name="ma-source" value="reuters"> Reuters</label>
                            <label><input type="checkbox" name="ma-source" value="bloomberg"> Bloomberg</label>
                            <label><input type="checkbox" name="ma-source" value="seekingalpha"> Seeking Alpha</label>
                        </div>
                    </div>

                    <div class="ma-control-group">
                        <div class="ma-control-label">Search Keywords</div>
                        <input type="text" id="ma-keywords" placeholder="e.g., Microsoft, technology, $1 billion">
                    </div>

                    <div class="ma-control-group">
                        <div class="ma-control-label">Date Range (Optional)</div>
                        <div class="grid">
                            <input type="date" id="ma-date-from">
                            <input type="date" id="ma-date-to">
                        </div>
                    </div>

                    <div class="ma-control-group">
                        <div class="ma-control-label">Options</div>
                        <div class="ma-checkbox-group">
                            <label><input type="checkbox" id="ma-auto-discover" checked> Auto-discover URLs</label>
                            <label><input type="checkbox" id="ma-use-rss" checked> Use RSS feeds</label>
                            <label><input type="checkbox" id="ma-high-confidence"> High confidence only</label>
                        </div>
                    </div>
                </div>

                <div class="ma-action-bar">
                    <button id="ma-scrape-btn">Scrape M&amp;A News</button>
                    <button id="ma-export-btn" class="hidden">Export Results</button>
                    <button id="ma-clear-btn" class="hidden">Clear Results</button>
                </div>

                <div id="ma-loading" class="ma-loading">Discovering and scraping M&amp;A news…</div>
                <div id="ma-results" class="ma-results"></div>
            </section>
        </main>
    </div>

    <script src="/http-client.js"></script>
    <script src="/config.js"></script>
    <script src="/components/navigation.js"></script>
    <script src="/components/error-handler.js"></script>
    <script src="/components/file-uploader.js"></script>
    <script src="/components/loader.js"></script>
    <script src="/enhanced-url-validator.js"></script>
    <script src="/batch-processor.js"></script>
    <script src="/assets/js/bulk-scraper.js"></script>
    <script>
    (function() {
        const scrapeBtn = document.getElementById('ma-scrape-btn');
        const exportBtn = document.getElementById('ma-export-btn');
        const clearBtn = document.getElementById('ma-clear-btn');
        const loadingDiv = document.getElementById('ma-loading');
        const resultsDiv = document.getElementById('ma-results');

        if (!scrapeBtn) {
            return;
        }

        let lastResults = null;

        scrapeBtn.addEventListener('click', async function() {
            const sources = Array.from(document.querySelectorAll('input[name="ma-source"]:checked'))
                .map(cb => cb.value);

            if (sources.length === 0) {
                alert('Please select at least one news source.');
                return;
            }

            const keywords = document.getElementById('ma-keywords').value;
            const dateFrom = document.getElementById('ma-date-from').value;
            const dateTo = document.getElementById('ma-date-to').value;
            const autoDiscover = document.getElementById('ma-auto-discover').checked;
            const useRSS = document.getElementById('ma-use-rss').checked;
            const highConfidenceOnly = document.getElementById('ma-high-confidence').checked;

            const urlTextarea = document.getElementById('urlInput');
            const manualUrls = !autoDiscover && urlTextarea
                ? urlTextarea.value.split('\n').filter(u => u.trim())
                : [];

            scrapeBtn.disabled = true;
            loadingDiv.classList.add('active');
            resultsDiv.classList.remove('active');
            exportBtn.classList.add('hidden');
            clearBtn.classList.add('hidden');

            try {
                const response = await fetch('/.netlify/functions/ma-news-scraper', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        urls: manualUrls,
                        mode: 'ma',
                        discover: autoDiscover,
                        sources,
                        keywords,
                        dateRange: {
                            from: dateFrom,
                            to: dateTo
                        },
                        concurrency: 3,
                        maxUrls: 50,
                        useRSS,
                        minConfidence: highConfidenceOnly ? 75 : 0
                    })
                });

                const data = await response.json();

                if (data.success) {
                    lastResults = data;
                    displayResults(data, highConfidenceOnly);
                    exportBtn.classList.remove('hidden');
                    clearBtn.classList.remove('hidden');
                } else {
                    alert('Error: ' + (data.error || 'Scraping failed'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            } finally {
                scrapeBtn.disabled = false;
                loadingDiv.classList.remove('active');
            }
        });

        function displayResults(data, highConfidenceOnly) {
            const minConfidence = highConfidenceOnly ? 75 : 50;
            const deals = data.results
                .filter(r => r.success && r.data && r.data.confidence >= minConfidence)
                .sort((a, b) => (b.data.confidence || 0) - (a.data.confidence || 0));

            let html = `
                <div class="ma-stats">
                    <div class="ma-stat">
                        <div class="ma-stat-value">${data.stats.total}</div>
                        <div class="ma-stat-label">URLs Processed</div>
                    </div>
                    <div class="ma-stat">
                        <div class="ma-stat-value">${data.stats.successful}</div>
                        <div class="ma-stat-label">Successful</div>
                    </div>
                    <div class="ma-stat">
                        <div class="ma-stat-value">${data.stats.ma_detected}</div>
                        <div class="ma-stat-label">M&A Deals Found</div>
                    </div>
                    <div class="ma-stat">
                        <div class="ma-stat-value">${data.stats.deals_with_value || 0}</div>
                        <div class="ma-stat-label">With Deal Value</div>
                    </div>
                </div>
            `;

            if (deals.length > 0) {
                html += '<div class="ma-deals">';
                deals.forEach(deal => {
                    const d = deal.data;
                    const confidenceValue = typeof d.confidence === 'number' ? d.confidence : 0;
                    const confidenceClass = confidenceValue >= 75
                        ? 'ma-confidence-high'
                        : confidenceValue >= 50
                            ? 'ma-confidence-medium'
                            : 'ma-confidence-low';
                    const severityLabel = confidenceValue >= 75 ? 'High' : confidenceValue >= 50 ? 'Medium' : 'Low';
                    const confidenceLabel = `${severityLabel} • ${confidenceValue}%`;
                    const confidenceAria = `${severityLabel} confidence (${confidenceValue}% confidence score)`;

                    html += `
                        <div class="ma-deal">
                            <div class="ma-deal-header">
                                <div>
                                    <div class="ma-deal-title">${d.title || 'Untitled'}</div>
                                    <a href="${deal.url}" target="_blank" class="ma-deal-url">${deal.url}</a>
                                </div>
                                <span
                                    class="ma-confidence ${confidenceClass}"
                                    data-severity="${severityLabel.toLowerCase()}"
                                    aria-label="${confidenceAria}"
                                >${confidenceLabel}</span>
                            </div>
                            <div class="ma-deal-details">
                                ${d.dealValue ? `
                                    <div class="ma-detail">
                                        <div class="ma-detail-label">Deal Value</div>
                                        <div class="ma-detail-value ma-deal-value">${d.dealValue.display}</div>
                                    </div>
                                ` : ''}
                                ${d.companies && d.companies.length > 0 ? `
                                    <div class="ma-detail">
                                        <div class="ma-detail-label">Companies</div>
                                        <div class="ma-detail-value">${d.companies.slice(0, 3).join(', ')}</div>
                                    </div>
                                ` : ''}
                                <div class="ma-detail">
                                    <div class="ma-detail-label">Transaction Type</div>
                                    <div class="ma-detail-value">${d.transactionType || 'Unknown'}</div>
                                </div>
                                ${d.dates && d.dates.length > 0 ? `
                                    <div class="ma-detail">
                                        <div class="ma-detail-label">Date</div>
                                        <div class="ma-detail-value">${d.dates[0].parsed}</div>
                                    </div>
                                ` : ''}
                                ${d.advisors && d.advisors.length > 0 ? `
                                    <div class="ma-detail">
                                        <div class="ma-detail-label">Advisors</div>
                                        <div class="ma-detail-value">${d.advisors.slice(0, 2).join(', ')}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${d.summary ? `
                                <div class="ma-summary">
                                    <div class="ma-detail-label">Summary</div>
                                    <div class="ma-summary-text">${d.summary}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p>No M&A transactions detected in the scraped content.</p>';
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('active');
        }

        exportBtn.addEventListener('click', function() {
            if (!lastResults) return;
            const dataStr = JSON.stringify(lastResults, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = `ma-news-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        });

        clearBtn.addEventListener('click', function() {
            resultsDiv.classList.remove('active');
            resultsDiv.innerHTML = '';
            exportBtn.classList.add('hidden');
            clearBtn.classList.add('hidden');
            lastResults = null;
        });
    })();
    </script>
</body>
</html>
