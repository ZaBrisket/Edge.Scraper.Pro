<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Processing Integration Test</title>
    <script src="pfr-validator.js"></script>
    <script src="batch-processor.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Batch Processing Integration Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>Timeout: <span id="timeout">10000</span>ms</p>
        <p>Concurrency: <span id="concurrency">2</span></p>
        <p>Delay: <span id="delay">100</span>ms</p>
    </div>
    
    <button id="runTests">Run Integration Tests</button>
    
    <div id="results"></div>
    
    <script>
        // Set timeout configuration
        window.HTTP_DEADLINE_MS = '15000';
        const TIMEOUT_MS = parseInt(window.HTTP_DEADLINE_MS || '10000', 10);
        document.getElementById('timeout').textContent = TIMEOUT_MS;
        
        // Test URLs
        const testUrls = [
            // Valid PFR URLs
            'https://www.pro-football-reference.com/players/M/MahoPa00.htm',
            'https://www.pro-football-reference.com/players/A/AlleJo00.htm',
            'https://www.pro-football-reference.com/players/B/BradTo00.htm',
            
            // Duplicates with tracking params
            'https://www.pro-football-reference.com/players/M/MahoPa00.htm?utm_source=test',
            'https://www.pro-football-reference.com/players/A/AlleJo00.htm#stats',
            
            // Invalid URLs
            'not-a-url-at-all',
            'ftp://wrong-protocol.com/file',
            'https://invalid-domain.com/player',
            'https://www.pro-football-reference.com/teams/kan/2023.htm',
            
            // More valid URLs
            'https://www.pro-football-reference.com/players/K/KelcTr00.htm',
            'https://www.basketball-reference.com/players/j/jamesle01.html',
        ];
        
        // Mock API fetch function
        async function mockFetchUrl(url) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 50 + Math.random() * 100));
            
            // Simulate different responses
            if (url.includes('MahoPa00')) {
                return { html: '<html><body>Patrick Mahomes content</body></html>' };
            } else if (url.includes('AlleJo00')) {
                return { html: '<html><body>Josh Allen content</body></html>' };
            } else if (url.includes('BradTo00')) {
                // Simulate timeout
                await new Promise(resolve => setTimeout(resolve, 20000));
                return { html: '<html><body>Tom Brady content</body></html>' };
            } else if (url.includes('KelcTr00')) {
                // Simulate server error
                throw new Error('Server error: 503 Service Unavailable');
            } else if (url.includes('jamesle01')) {
                // Simulate rate limiting
                const error = new Error('Rate limit exceeded');
                error.status = 429;
                throw error;
            }
            
            return { html: '<html><body>Default content</body></html>' };
        }
        
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            const log = (message, className = '') => {
                const div = document.createElement('div');
                div.className = className;
                div.textContent = message;
                resultsDiv.appendChild(div);
            };
            
            const logPre = (obj) => {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(obj, null, 2);
                resultsDiv.appendChild(pre);
            };
            
            log('Starting integration tests...', 'test-section');
            
            // Test 1: PFR Validator
            log('\n=== Test 1: PFR URL Validation ===', 'test-section');
            const validator = new PFRValidator();
            const validationResult = validator.validateBatch(testUrls);
            
            log(`Total URLs: ${validationResult.total}`);
            log(`Valid: ${validationResult.summary.validCount}`, 'success');
            log(`Invalid: ${validationResult.summary.invalidCount}`, 'error');
            log(`Duplicates: ${validationResult.summary.duplicateCount}`, 'warning');
            
            // Generate HTML report
            const reportHTML = validator.generateHTMLReport(validationResult);
            const reportDiv = document.createElement('div');
            reportDiv.innerHTML = reportHTML;
            resultsDiv.appendChild(reportDiv);
            
            // Test 2: Batch Processor
            log('\n=== Test 2: Batch Processing ===', 'test-section');
            
            const progressLogs = [];
            const processor = new BatchProcessor({
                concurrency: 2,
                delayMs: 100,
                timeout: TIMEOUT_MS,
                onProgress: (progress) => {
                    progressLogs.push(progress);
                    if (progress.phase === 'processing') {
                        log(`Progress: ${progress.completed}/${progress.total} (${progress.percentage}%)`);
                    }
                },
                onError: (error) => {
                    log(`Batch error: ${error.error}`, 'error');
                },
                onComplete: (result) => {
                    log('Batch processing completed!', 'success');
                }
            });
            
            try {
                const result = await processor.processBatch(testUrls, async (url, item) => {
                    const response = await mockFetchUrl(url);
                    return {
                        url,
                        content: response.html,
                        length: response.html.length
                    };
                });
                
                log('\n=== Processing Results ===', 'test-section');
                log(result.summary.overview);
                log(result.summary.validation);
                log(result.summary.errors);
                log(result.summary.performance);
                log(result.summary.duration);
                
                // Test 3: Order Preservation
                log('\n=== Test 3: Order Preservation ===', 'test-section');
                const indices = result.results.map(r => r.index);
                const isOrdered = indices.every((idx, i) => i === 0 || idx > indices[i - 1]);
                log(`Order preserved: ${isOrdered ? 'YES' : 'NO'}`, isOrdered ? 'success' : 'error');
                log(`Result indices: ${indices.join(', ')}`);
                
                // Test 4: Error Reporting
                if (result.errorReport.totalErrors > 0) {
                    log('\n=== Test 4: Error Report ===', 'test-section');
                    
                    const errorReportHTML = processor.generateHTMLErrorReport(result.errorReport);
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = errorReportHTML;
                    resultsDiv.appendChild(errorDiv);
                    
                    log('\nError Export Data:', 'test-section');
                    logPre(result.errorReport.exportData);
                }
                
                // Test 5: Control Methods
                log('\n=== Test 5: Pause/Resume/Stop Controls ===', 'test-section');
                
                const controlProcessor = new BatchProcessor({
                    concurrency: 1,
                    delayMs: 500,
                    timeout: TIMEOUT_MS
                });
                
                let controlState = [];
                const controlPromise = controlProcessor.processBatch(
                    ['https://test1.com', 'https://test2.com', 'https://test3.com', 'https://test4.com'],
                    async (url) => {
                        controlState.push({ url, state: controlProcessor.state });
                        await new Promise(resolve => setTimeout(resolve, 300));
                        return { url, processed: true };
                    }
                );
                
                // Test pause
                setTimeout(() => {
                    controlProcessor.pause();
                    log('Paused processor', 'warning');
                }, 400);
                
                // Test resume
                setTimeout(() => {
                    controlProcessor.resume();
                    log('Resumed processor', 'success');
                }, 1000);
                
                // Test stop
                setTimeout(() => {
                    controlProcessor.stop();
                    log('Stopped processor', 'error');
                }, 1800);
                
                try {
                    await controlPromise;
                } catch (error) {
                    log('Control test completed (processor stopped)', 'warning');
                    log(`URLs processed before stop: ${controlState.length}`);
                }
                
                log('\n=== All Tests Completed ===', 'success test-section');
                
            } catch (error) {
                log(`Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        document.getElementById('runTests').addEventListener('click', runTests);
    </script>
</body>
</html>