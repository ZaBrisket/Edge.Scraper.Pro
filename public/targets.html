<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>M&A Target List Builder - EdgeScraperPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Transform SourceScrub CSV exports into curated M&A target lists with filtering, search, and export capabilities.">
  <link rel="icon" href="/favicon.ico">
  
  <style>
    /* Modern Dark Theme Design System */
    :root {
      --bg-primary: #0f0f13;
      --bg-secondary: #16161c;
      --bg-tertiary: #1b1c24;
      --border-primary: #22232a;
      --border-secondary: #2b2d36;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --text-muted: #6b7280;
      --accent-green: #4ade80;
      --accent-blue: #60a5fa;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Layout */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    header {
      background: rgba(15, 15, 19, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-primary);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }
    
    nav {
      display: flex;
      gap: 0.5rem;
    }
    
    nav a {
      padding: 0.5rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    
    nav a:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
    }
    
    nav a.active {
      color: var(--accent-green);
      background: rgba(74, 222, 128, 0.1);
    }
    
    main {
      flex: 1;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    /* Panels */
    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    
    .panel-header {
      margin-bottom: 1.5rem;
    }
    
    .panel-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .panel-description {
      color: var(--text-secondary);
    }
    
    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border-secondary);
      border-radius: 0.75rem;
      padding: 3rem 2rem;
      text-align: center;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .upload-zone:hover {
      border-color: var(--accent-blue);
      background: rgba(96, 165, 250, 0.05);
    }
    
    .upload-zone.dragover {
      border-color: var(--accent-green);
      background: rgba(74, 222, 128, 0.05);
      transform: scale(1.02);
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .upload-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .upload-subtitle {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    input[type="file"] {
      display: none;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.5rem;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      font-family: inherit;
      line-height: 1.5;
    }
    
    .btn-primary {
      background: var(--accent-green);
      color: #000;
      border-color: var(--accent-green);
    }
    
    .btn-primary:hover {
      background: #3bcc70;
      border-color: #3bcc70;
    }
    
    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-secondary);
    }
    
    .btn-secondary:hover {
      background: var(--border-primary);
    }
    
    .btn-danger {
      background: transparent;
      color: var(--danger);
      border-color: var(--danger);
    }
    
    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    /* Controls */
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-primary);
    }
    
    .control-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-input,
    .select-filter {
      padding: 0.625rem 1rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-secondary);
      border-radius: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      min-width: 150px;
      transition: all 0.2s;
    }
    
    .search-input {
      min-width: 250px;
    }
    
    .search-input:focus,
    .select-filter:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    .search-input::placeholder {
      color: var(--text-muted);
    }
    
    .checkbox-group {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .checkbox-group:hover {
      background: var(--bg-primary);
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
    }
    
    .checkbox-group label {
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: 0.5rem;
      padding: 1.25rem;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-blue);
      line-height: 1;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    /* Pills/Tags */
    .pill {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: 9999px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0.125rem;
    }
    
    .pill-container {
      margin-top: 0.5rem;
      line-height: 2;
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      margin-top: 1.5rem;
      border: 1px solid var(--border-primary);
      border-radius: 0.5rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    thead {
      background: var(--bg-tertiary);
      border-bottom: 2px solid var(--border-primary);
    }
    
    th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      position: relative;
    }
    
    th:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
    }
    
    th.sortable::after {
      content: '⇅';
      position: absolute;
      right: 0.5rem;
      opacity: 0.3;
    }
    
    th.sorted-asc::after {
      content: '↑';
      opacity: 1;
      color: var(--accent-blue);
    }
    
    th.sorted-desc::after {
      content: '↓';
      opacity: 1;
      color: var(--accent-blue);
    }
    
    tbody tr {
      border-bottom: 1px solid var(--border-primary);
      transition: background 0.2s;
    }
    
    tbody tr:hover {
      background: var(--bg-tertiary);
    }
    
    td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
    }
    
    td.mono {
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }
    
    td.number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    td.wrap {
      white-space: pre-wrap;
      max-width: 250px;
    }
    
    /* Company Logo */
    .company-logo {
      width: 32px;
      height: 32px;
      border-radius: 0.375rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      object-fit: contain;
      display: block;
    }
    
    .logo-placeholder {
      width: 32px;
      height: 32px;
      border-radius: 0.375rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* Messages */
    .message {
      padding: 1rem 1.25rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .message-success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: var(--success);
    }
    
    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }
    
    .message-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }
    
    /* Issues Box */
    .issues-box {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: 0.5rem;
    }
    
    .issues-box summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 0.5rem;
    }
    
    .issues-box ul {
      margin-top: 0.5rem;
      margin-left: 1.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    /* Toggle control styles */
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-secondary);
      user-select: none;
    }
    
    .toggle-label input[type="checkbox"] {
      width: 40px;
      height: 20px;
      appearance: none;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .toggle-label input[type="checkbox"]:checked {
      background: var(--accent-green);
      border-color: var(--accent-green);
    }
    
    .toggle-label input[type="checkbox"]::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 1px;
      left: 1px;
      transition: transform 0.2s ease;
    }
    
    .toggle-label input[type="checkbox"]:checked::after {
      transform: translateX(20px);
    }
    
    .help-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: 4px;
    }
    
    /* Progress indicator for batch processing */
    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .processing-modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      padding: 24px;
      min-width: 300px;
      text-align: center;
    }
    
    .processing-modal h3 {
      margin: 0 0 16px;
      color: var(--text-primary);
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent-green);
      transition: width 0.3s ease;
    }
    
    /* Export controls styling */
    .export-controls h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    
    .export-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      line-height: 1.4;
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    .text-muted {
      color: var(--text-secondary);
    }
    
    .text-small {
      font-size: 0.875rem;
    }
    
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid var(--border-secondary);
      border-top-color: var(--accent-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
      }
      
      .search-input,
      .select-filter {
        width: 100%;
      }
      
      .table-container {
        margin-left: -1.5rem;
        margin-right: -1.5rem;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="header-content">
        <div class="logo">EdgeScraperPro</div>
        <nav>
          <a href="/">Scraper</a>
          <a href="/targets" class="active">Target Lists</a>
          <a href="https://github.com/ZaBrisket/Edge.Scraper.Pro" target="_blank">GitHub</a>
        </nav>
      </div>
    </header>
    
    <main>
      <!-- Upload Panel -->
      <div class="panel">
        <div class="panel-header">
          <h1 class="panel-title">M&A Target List Builder</h1>
          <p class="panel-description">Upload your SourceScrub CSV export to generate a curated target universe with advanced filtering and export capabilities.</p>
        </div>
        
        <div id="uploadZone" class="upload-zone" tabindex="0" role="button" aria-label="Upload CSV file">
          <div class="upload-icon">📂</div>
          <div class="upload-title">Drop your SourceScrub CSV here</div>
          <div class="upload-subtitle">or click to browse</div>
          <button class="btn btn-primary">Select CSV File</button>
          <input type="file" id="fileInput" accept=".csv,text/csv">
        </div>
        
        <div id="uploadMessage" class="hidden"></div>
        
        <div class="controls">
          <div class="control-group">
            <input type="text" id="searchInput" class="search-input" placeholder="Search companies, executives, cities...">
            <select id="stateFilter" class="select-filter">
              <option value="">All States</option>
            </select>
            <select id="industryFilter" class="select-filter">
              <option value="">All Industries</option>
            </select>
            <select id="endMarketFilter" class="select-filter">
              <option value="">All End Markets</option>
            </select>
          </div>
          
          <!-- Include emails control -->
          <div class="control-group">
            <label>
              <input type="checkbox" id="includePII" checked>
              <span>Include emails in export</span>
            </label>
          </div>

          <!-- Standardization toggle (separate control group) -->
          <div class="control-group">
            <label class="toggle-label">
              <input type="checkbox" id="toggleStandardization" checked>
              <span>Standardize Descriptions</span>
            </label>
            <span class="help-text">Apply AI-powered description standardization</span>
          </div>
          
          <div class="export-controls">
            <h3>Export Options</h3>
            
            <div class="btn-group">
              <button id="clearBtn" class="btn btn-danger">Clear All</button>
              <button id="exportCsvBtn" class="btn btn-secondary">Export CSV</button>
              <button id="exportExcelBtn" class="btn btn-primary">Export Excel (Professional)</button>
              <button id="exportExcel365Btn" class="btn btn-secondary" 
                      title="For Excel 365/Office 365 users - includes embedded logo images">
                Excel 365 + Logos
              </button>
            </div>
            
            <p class="export-note">
              Professional Excel export includes formatting, multiple sheets, and summary statistics.<br>
              Use Excel 365 version if you have Office 365 for automatic logo display.
            </p>
          </div>
        </div>
      </div>
      
      <!-- Statistics Panel -->
      <div id="statsPanel" class="panel hidden">
        <h2 class="panel-title">Summary Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statCount">0</div>
            <div class="stat-label">Companies</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statRevenue">$0</div>
            <div class="stat-label">Median Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEmployees">0</div>
            <div class="stat-label">Median Employees</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statStates">0</div>
            <div class="stat-label">States</div>
          </div>
        </div>
        <div id="statDetails" class="pill-container"></div>
      </div>
      
      <!-- Data Table Panel -->
      <div id="tablePanel" class="panel hidden">
        <h2 class="panel-title">Target Universe</h2>
        <div class="table-container">
          <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        
        <details id="dataIssues" class="issues-box hidden">
          <summary>Data Quality Issues</summary>
          <div id="issuesList"></div>
        </details>
      </div>
      
      <!-- Footer -->
      <div class="panel">
        <p class="text-small text-muted">
          All data processing happens locally in your browser. No data is sent to external servers. 
          Company logos are fetched from Clearbit's public API. Your previous session is saved in browser storage.
        </p>
      </div>
    </main>
  </div>
  
  <!-- Vendor Libraries -->
  <script src="/vendor/papaparse.min.js"></script>
  <script src="/vendor/xlsx.full.min.js"></script>
  <!-- Add ExcelJS library for Excel formatting support -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  
  <!-- Description Standardizer Module -->
  <script src="description-standardizer.js"></script>
  
  <!-- Application Code -->
  <script src="/targets.js"></script>

  <!-- CDSEngine: deterministic company one-liners -->
  <script src="./js/summary-engine.js"></script>
  <script>
  /* Minimal integration glue: Adds/updates row.Summary using CDSEngine.
     Assumes the page already parses CSV/XLSX and holds a rows array. */
  (function(){
    // Helper: build a column map from the keys of the first row if not already mapped
    function __espBuildColMapFromRows(rows){
      if (!rows || !rows.length) return null;
      const headers = Object.keys(rows[0]||{});
      return (window.CDSEngine && window.CDSEngine.buildColMap)
        ? window.CDSEngine.buildColMap(headers)
        : null;
    }

    // Idempotent pass: compute row.Summary if missing or empty
    function __espApplySummaries(rows){
      if (!Array.isArray(rows) || !rows.length || !window.CDSEngine) return rows;
      const prepared = window.CDSEngine.prepare(rows);
      const cols = prepared.cols || __espBuildColMapFromRows(rows) || {};
      for (let i=0; i<prepared.rows.length; i++){
        const r = prepared.rows[i];
        const s = window.CDSEngine.makeSummary(r, cols);
        if (!r.Summary || typeof r.Summary !== "string" || !r.Summary.trim()) {
          r.Summary = s;
        } else {
          // If an existing Summary exceeds 30 words or is multi-sentence, replace it.
          const words = r.Summary.trim().split(/\s+/);
          if (words.length > 30 || /[.!?].+/.test(r.Summary.trim())) r.Summary = s;
        }
      }
      return prepared.rows;
    }

    // CSV injection guard (prefixes risky cells with apostrophe)
    function __espSanitizeForCsv(v){
      let s = String(v==null?"":v);
      if (/^[=+\-@]/.test(s)) s = "'" + s;
      if (s.includes('"') || s.includes(",") || s.includes("\n")) s = '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    // Patch common export helpers if present
    function __espWrapCsvExporter(){
      try{
        // Detect a global toCsv function; wrap if found
        if (typeof window.toCsv === "function" && !window.__espToCsvWrapped){
          const orig = window.toCsv;
          window.toCsv = function(rows, headers){
            rows = __espApplySummaries(rows);
            const out = [];
            out.push(headers.join(","));
            for (const r of rows){
              out.push(headers.map(h=>__espSanitizeForCsv(r[h])).join(","));
            }
            return out.join("\n");
          };
          window.__espToCsvWrapped = true;
        }
      }catch(e){}
    }

    // Try to discover likely data arrays and keep them standardized
    function __espTryPatchPipelines(){
      // 1) If a global like latestRows / rows / records exists, standardize it in-place
      const cands = ["latestRows","rows","records","tableRows","data","dataset","targets","targetsData"];
      for (const name of cands){
        if (Array.isArray(window[name]) && window[name].length){
          window[name] = __espApplySummaries(window[name]);
        }
      }

      // 2) Patch CSV exporter if present
      __espWrapCsvExporter();

      // 3) Hook common XLSX export calls if reachable
      if (window.XLSX && XLSX.utils && typeof XLSX.utils.json_to_sheet === "function" && !window.__espXlsxHooked){
        const origJsonToSheet = XLSX.utils.json_to_sheet;
        XLSX.utils.json_to_sheet = function(rows, opts){
          rows = __espApplySummaries(rows);
          return origJsonToSheet(rows, opts);
        };
        window.__espXlsxHooked = true;
      }
    }

    // Run once after page scripts load
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(__espTryPatchPipelines, 0);
    } else {
      document.addEventListener("DOMContentLoaded", __espTryPatchPipelines);
    }

    // Safety: re-run before export buttons if they exist
    function __espAttachExportGuards(){
      const btnTexts = ["Export CSV","Export XLSX","Export Excel"];
      document.addEventListener("click", function(ev){
        const el = ev.target;
        if (!el || el.tagName !== "BUTTON") return;
        const t = (el.textContent||"").trim();
        if (btnTexts.includes(t)) {
          __espTryPatchPipelines(); // ensure summaries are fresh
        }
      }, true);
    }
    __espAttachExportGuards();

    // Override legacy standardizer to route through CDSEngine
    (function __espOverrideStandardizer(){
      try{
        if (window.DescriptionStandardizer && window.CDSEngine && !window.__espStdOverridden){
          const original = window.DescriptionStandardizer.standardize;
          window.DescriptionStandardizer.standardize = function(data){
            try{
              const cols = {
                companyName: 'companyName',
                website: 'website',
                description: 'description',
                specialties: 'specialties',
                products: 'productsServices',
                endMarkets: 'endMarkets',
                industries: 'industries'
              };
              // Prefer raw description text if present on input
              if (data && data.rawDescription && !data.description) {
                data.description = data.rawDescription;
              }
              return window.CDSEngine.makeSummary(data || {}, cols);
            }catch(e){
              try{ return original(data); }catch{ return (data && (data.description||'')) || ''; }
            }
          };
          window.__espStdOverridden = true;
        }
      }catch(e){}
    })();

    // Ensure Summary column is visible in preview by augmenting the table after render
    function __espEnsurePreviewSummary(){
      try{
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        if (!thead || !tbody) return;
        const headerRow = thead.querySelector('tr');
        if (!headerRow) return;
        const headerTexts = Array.from(headerRow.children).map(th => (th.textContent||'').trim());
        if (!headerTexts.includes('Summary')){
          const th = document.createElement('th');
          th.textContent = 'Summary';
          headerRow.appendChild(th);
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const data = (window.AppState && Array.isArray(AppState.filtered)) ? AppState.filtered : [];
          rows.forEach((tr, idx)=>{
            const td = document.createElement('td');
            td.className = 'wrap';
            const r = data[idx] || {};
            const cols = {
              companyName: 'companyName',
              website: 'website',
              description: r.rawDescription ? 'rawDescription' : 'description',
              specialties: 'specialties',
              products: 'productsServices',
              endMarkets: 'endMarkets',
              industries: 'industries'
            };
            let s = r.Summary && String(r.Summary).trim();
            if (!s && window.CDSEngine){ s = window.CDSEngine.makeSummary(r, cols); }
            td.textContent = s || (r.description || '');
            tr.appendChild(td);
          });
        }
      }catch(e){}
    }

    // Wrap renderTable to append Summary column after it runs
    (function __espWrapRender(){
      try{
        if (typeof window.renderTable === 'function' && !window.__espRenderWrapped){
          const orig = window.renderTable;
          window.renderTable = function(){
            const res = orig.apply(this, arguments);
            __espEnsurePreviewSummary();
            return res;
          };
          window.__espRenderWrapped = true;
        }
      }catch(e){}
    })();

    // Override CSV export to include Summary and guard against injection
    (function __espOverrideExportCsv(){
      try{
        if (typeof window.exportCSV === 'function' && !window.__espExportCsvOverridden){
          window.exportCSV = function(){
            const data = (window.AppState && Array.isArray(AppState.filtered)) ? AppState.filtered : [];
            if (!data.length){
              if (typeof window.showMessage === 'function') showMessage('No data to export', 'warning');
              return;
            }
            const includePII = (document.getElementById('includePII')||{}).checked;
            const headers = [
              '#','Company','City','State','City, State','Website','Domain',
              'Standardized Description','Summary','Original Description','Count','Est. Rev ($MM)','Executive Title','Executive Name','Latest Revenue ($)'
            ];
            if (includePII) headers.push('Executive Email');
            const out = [];
            out.push(headers.join(','));
            for (let i=0;i<data.length;i++){
              const r = data[i] || {};
              const cols = {
                companyName: 'companyName',
                website: 'website',
                description: r.rawDescription ? 'rawDescription' : 'description',
                specialties: 'specialties',
                products: 'productsServices',
                endMarkets: 'endMarkets',
                industries: 'industries'
              };
              const summary = (r.Summary && String(r.Summary).trim()) || (window.CDSEngine ? window.CDSEngine.makeSummary(r, cols) : (r.description||''));
              const rowArr = [
                i + 1,
                r.informalName || r.companyName || '',
                r.city || '',
                r.state || '',
                r.cityState || [r.city||'', r.state||''].filter(Boolean).join(', '),
                r.website || '',
                r.domain || '',
                r.description || '',
                summary || '',
                r.rawDescription || '',
                (r.employeeCount != null ? r.employeeCount : (r.employeeRange || '')),
                (r.revenueMM != null ? Number(r.revenueMM).toFixed(2) : ''),
                r.execTitle || '',
                r.execName || '',
                r.revenue || ''
              ];
              if (includePII) rowArr.push(r.execEmail || '');
              out.push(rowArr.map(__espSanitizeForCsv).join(','));
            }
            const csv = out.join('\n');
            const timestamp = new Date().toISOString().split('T')[0];
            if (typeof window.downloadFile === 'function'){
              downloadFile(csv, `target-universe-${timestamp}.csv`, 'text/csv');
            } else {
              const blob = new Blob([csv], { type: 'text/csv' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `target-universe-${timestamp}.csv`;
              a.click();
              URL.revokeObjectURL(url);
            }
          };
          window.__espExportCsvOverridden = true;
        }
      }catch(e){}
    })();
  })();
  </script>
</body>
</html>