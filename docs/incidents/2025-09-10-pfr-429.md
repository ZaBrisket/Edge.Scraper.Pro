# Incident Report: PFR 429 Rate Limit Errors
Date: 2025-09-10

## Summary
On September 10, 2025, between 18:27:00Z and 18:27:07Z, we experienced a burst of 35 server errors when fetching Pro-Football-Reference (PFR) player pages. All errors were incorrectly mapped from upstream 429 rate limit responses to 500 server errors, causing our circuit breaker to trip unnecessarily.

## Impact
- **35 failed requests** to www.pro-football-reference.com
- **20 rate limit (429) responses** incorrectly surfaced as 500 errors
- **15 circuit breaker open events** preventing further requests
- **5 unique player URLs** affected in the batch

## Root Cause Analysis

### Primary Issues Identified:
1. **Incorrect Error Mapping**: HTTP 429 responses are being caught and re-thrown as 500 server errors
2. **Circuit Breaker Misconfiguration**: 429 responses count toward circuit breaker failure threshold
3. **Missing Per-Host Rate Limiting**: No pre-request gating to prevent hitting upstream limits
4. **No Retry-After Support**: System doesn't respect rate limit headers from upstream

### Error Pattern:
```
[500] Upstream 429
[500] Circuit for www.pro-football-reference.com is open
```

## Sample Affected URLs:
- https://www.pro-football-reference.com/players/A/AlleJo00.htm
- https://www.pro-football-reference.com/players/B/BradTo00.htm
- https://www.pro-football-reference.com/players/M/MahoPa00.htm
- https://www.pro-football-reference.com/players/R/RodgAa00.htm
- https://www.pro-football-reference.com/players/W/WilsRu00.htm

## Code Analysis
The issue stems from `/workspace/src/lib/http/client.js`:
- Line 127-129: 429 responses throw `RateLimitError` 
- Line 146-151: Rate limit errors increment circuit breaker failure count
- Line 166-171: No special handling for rate limit errors in retry logic

## Recommendations
1. Treat 429 as a deferrrable condition, not a fatal error
2. Implement per-host rate limiting with token bucket
3. Add exponential backoff with jitter for 429 responses
4. Exclude 429s from circuit breaker failure counting
5. Support Retry-After header parsing
6. Add proper observability for rate limit events

## Immediate Actions Needed
- Fix error mapping to preserve 429 status
- Implement pre-request rate limiting
- Add proper retry logic for rate-limited requests
- Configure circuit breaker to ignore 429s