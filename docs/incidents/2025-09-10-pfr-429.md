# Incident Report: Pro-Football-Reference 429 Rate Limit Issues

**Date:** 2025-09-10  
**Time Window:** 18:27:03 - 18:27:46 UTC (43 seconds)  
**Severity:** High - Batch processing failures  
**Status:** Resolved with resilient HTTP implementation  

## Summary

Batch processing of Pro-Football-Reference (PFR) player pages experienced widespread failures due to improper handling of upstream 429 rate limit responses. The system incorrectly mapped 429s to 500 errors and triggered circuit breaker opens, causing cascading failures.

## Impact

- **35 total errors** across 35 unique PFR player URLs
- **18 upstream 429s** incorrectly surfaced as "[500] Upstream 429"  
- **17 circuit breaker opens** triggered by the mishandled 429s
- **100% failure rate** for affected batch during the incident window
- **Zero successful requests** completed during this period

## Root Cause Analysis

### Primary Issues

1. **Incorrect Error Mapping**: 429 responses were being mapped to 500 status codes instead of being treated as expected rate limiting conditions
2. **Circuit Breaker Contamination**: Rate limit responses (429s) were counted as failures, causing premature circuit breaker opens
3. **No Rate Limiting**: Lack of pre-request rate limiting led to overwhelming the upstream server
4. **No Retry-After Support**: System didn't respect or implement Retry-After header handling
5. **Missing Backoff Strategy**: No exponential backoff with jitter for rate-limited requests

### Technical Details

```json
// Example 429→500 mapping error
{
  "timestamp": "2025-09-10T18:27:03.123Z",
  "type": "server_error",
  "host": "www.pro-football-reference.com", 
  "status_code": 500,
  "message": "[500] Upstream 429"
}

// Resulting circuit breaker open
{
  "timestamp": "2025-09-10T18:27:05.789Z",
  "type": "circuit_breaker",
  "status_code": 500,
  "message": "[500] Circuit breaker for www.pro-football-reference.com is open"
}
```

## Error Breakdown

| Error Type | Count | Percentage |
|------------|-------|------------|
| server_error (429→500) | 18 | 51.4% |
| circuit_breaker | 17 | 48.6% |
| **Total** | **35** | **100%** |

## Timeline

- **18:27:03Z**: First 429 mapped to 500 error
- **18:27:05Z**: Circuit breaker opens after threshold reached  
- **18:27:06-46Z**: Alternating pattern of 429→500 errors and circuit breaker rejections
- **18:27:46Z**: Last error in batch - circuit remained open

## Resolution

Implemented comprehensive resilient HTTP handling:

1. **Correct Error Classification**: 429s now treated as deferrals, not failures
2. **Per-Host Rate Limiting**: Token bucket limiter with configurable RPS per domain
3. **429-Aware Retries**: Retry-After header support with exponential backoff + jitter  
4. **Circuit Breaker Hygiene**: Only genuine 5xx/network errors count toward breaker
5. **Enhanced Observability**: Structured metrics for rate limiting and retry events

## Prevention

- **Rate Limiting**: Pre-request gating prevents overwhelming upstream servers
- **Proper Error Handling**: 429s trigger deferrals with appropriate backoff
- **Circuit Breaker Tuning**: Only opens on genuine failures, not rate limits
- **Configuration Management**: All timeouts and limits now config-driven
- **Monitoring**: New metrics track rate limit hits, deferrals, and retry scheduling

## Lessons Learned

1. **Rate limits are not errors** - they're expected conditions requiring deferral
2. **Circuit breakers must exclude rate limits** from failure calculations  
3. **Upstream politeness** requires pre-request rate limiting, not just post-failure handling
4. **Observability is critical** for distinguishing between different failure modes
5. **Configuration flexibility** enables tuning per-domain limits without code changes

## Related Changes

- Enhanced HTTP client in `src/lib/http/client.js`
- New rate limiting system with per-host token buckets
- Updated circuit breaker logic to exclude 429s
- Comprehensive test coverage for resilient HTTP patterns
- Documentation updates with tuning guidance

---

*Report generated using `tools/analyze_errors.js` on error log data*