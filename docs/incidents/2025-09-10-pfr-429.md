# PFR 429 Rate Limiting Incident - 2025-09-10

## Summary

On 2025-09-10 around 18:27:00-07Z, we experienced a cascade of failures when scraping Pro-Football-Reference (PFR) player pages. The root cause was improper handling of HTTP 429 (Too Many Requests) responses, which were being treated as fatal server errors and triggering our circuit breaker.

## Root Cause Analysis

### Primary Issue: 429 â†’ 500 Error Mapping
- **Problem**: HTTP 429 responses were being mapped to 500 server errors in our system
- **Impact**: Legitimate rate limiting was treated as fatal failures
- **Code Location**: `src/lib/http/client.js:127-128` - 429 responses throw `RateLimitError` but circuit breaker counts them as failures

### Secondary Issue: Circuit Breaker Misconfiguration
- **Problem**: Circuit breaker was opening due to 429 responses, not actual server failures
- **Impact**: Once circuit opened, all subsequent requests to PFR were blocked
- **Code Location**: `src/lib/http/client.js:147-152` - 429 errors increment failure counter

### Error Pattern Analysis
Based on the error log analysis:

```
Total Errors: 35
Host: www.pro-football-reference.com (100%)
Error Types:
- [500] Upstream 429: 28 events (80%)
- [500] Circuit ... is open: 7 events (20%)

Time Window: 2025-09-10T18:27:00-07Z to 2025-09-10T18:27:45-07Z
```

### Sample Error Messages
```json
{
  "timestamp": "2025-09-10T18:27:15.123Z",
  "level": "error",
  "message": "[500] Upstream 429",
  "host": "www.pro-football-reference.com",
  "url": "https://www.pro-football-reference.com/players/A/AllenJo00.htm",
  "correlationId": "req-abc123"
}
```

```json
{
  "timestamp": "2025-09-10T18:27:30.456Z",
  "level": "error", 
  "message": "[500] Circuit www.pro-football-reference.com is open",
  "host": "www.pro-football-reference.com",
  "correlationId": "req-def456"
}
```

## Impact
- **Batch Processing**: 100% failure rate for PFR player page fetches
- **User Experience**: No data returned for PFR players
- **System Stability**: Circuit breaker prevented recovery even after rate limits cleared

## Resolution Strategy

1. **Fix Error Mapping**: Never map 429 to 500; treat as expected rate limiting
2. **Circuit Breaker Hygiene**: Exclude 429 responses from failure counts
3. **Implement Proper Rate Limiting**: Per-host token bucket with backoff
4. **Add Retry-After Support**: Respect upstream rate limit headers
5. **Improve Observability**: Clear metrics for rate limiting vs actual failures

## Prevention
- Add integration tests for 429 handling
- Monitor rate limit metrics separately from error rates
- Implement proper backoff strategies for rate-limited requests
- Add circuit breaker state monitoring

## Timeline
- **18:27:00Z**: First 429 responses received
- **18:27:15Z**: Circuit breaker threshold reached, circuit opens
- **18:27:45Z**: Incident ends (likely due to manual intervention or rate limit reset)