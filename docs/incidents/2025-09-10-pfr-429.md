# Incident: PFR 429s surfaced as 500s and circuit opens (2025-09-10)

## Summary
On 2025-09-10 around 18:27:00–07Z, batches of Pro-Football-Reference player page fetches encountered upstream rate limiting (HTTP 429). These were incorrectly surfaced as 500s in our system, and repeated failures tripped the circuit breaker leading to additional "[500] Circuit ... is open" errors.

## Impact
- 35 server_error events for `www.pro-football-reference.com` player URLs
- Dominant patterns: `429 → surfaced as 500` and circuit open messages
- Batch user experience showed failures instead of deferrals

## Evidence (log snippets)
```
[500] Upstream 429
[500] Circuit www.pro-football-reference.com is open
[500] Upstream 500
```

## Counts (from analyzer)
Run:
```
node tools/analyze_errors.js --file "/mnt/data/error_report_2025-09-10 (3).json"
```
Findings:
- Total errors: 35
- Top host: `www.pro-football-reference.com`
- Status tallies: dominated by `429` and circuit-open events
- Time window: ~18:27:00–18:29:xx -07Z
- Unique URLs: multiple player pages (e.g., Mahomes, Allen, Kelce)

## Diagnosis
- 429 responses were thrown as errors and subsequently mapped to 500 at the function boundary.
- Circuit breaker counted 429s as failures, opening the circuit.

## Remediation
- Central HTTP client updated to:
  - Per-host token bucket with host-configurable RPS/BURST/CONCURRENCY
  - 429-aware retries honoring `Retry-After` with full-jitter backoff
  - 429s excluded from circuit-breaker failure counts; half-open probing added
  - Metrics: `rate_limit.hit`, `429.deferred`, `retry.scheduled`, `circuit.state`, `http.requests{host,status_class}`
- Function mapping updated: never map 429 to 500; return 429 with `retryAfterMs` when available

## Reproduction Notes
- Hammer `www.pro-football-reference.com` with >1 RPS without limiter; observe 429s.
- Prior behavior: subsequent `[500] Upstream 429` and circuit opens.
- With fix: 429s are deferred with scheduled retries and no circuit opens.

## Next Steps
- Tune defaults for PFR: `HOST_LIMIT__www.pro-football-reference.com__RPS=0.8`, `BURST=2`, `CONCURRENCY=1`.
- Monitor new metrics and adjust as needed.

