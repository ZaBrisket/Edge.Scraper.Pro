(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[197],{6229:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>x});var t=a(7876),l=a(4232),r=a(9099),i=a(7914),d=a(97),n=a(7328),c=a.n(n),m=a(7635);function o(e){let{jobId:s,onComplete:a}=e,[r,d]=(0,l.useState)({}),{data:n,refetch:c}=(0,i.I)({queryKey:["job-status",s],queryFn:async()=>{let e=await fetch("/api/jobs/".concat(s));if(!e.ok){var a;throw Error((null==(a=(await e.json()).error)?void 0:a.message)||"Failed to fetch job status")}return e.json()},refetchInterval:e=>(null==e?void 0:e.status)!=="completed"&&(null==e?void 0:e.status)!=="failed"&&2e3});(0,l.useEffect)(()=>{(null==n?void 0:n.status)==="completed"&&a&&a(s)},[null==n?void 0:n.status,s,a]);let m=async e=>{if(r[e])return void window.open(r[e],"_blank");try{let s=await fetch("/api/artifacts/".concat(e,"/signed-url"));if(!s.ok)throw Error("Failed to generate download URL");let a=await s.json();d(s=>({...s,[e]:a.downloadUrl})),window.open(a.downloadUrl,"_blank")}catch(e){console.error("Download error:",e),alert("Failed to download file. Please try again.")}};return n?(0,t.jsx)("div",{className:"card",children:(0,t.jsxs)("div",{className:"card-body",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("span",{className:"text-2xl",children:(e=>{switch(e){case"queued":return"⏳";case"processing":return"⚙️";case"completed":return"✅";case"failed":return"❌";default:return"❓"}})(n.status)}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("h4",{className:"font-semibold",children:[n.format.toUpperCase()," Export"]}),(0,t.jsxs)("p",{className:"text-sm text-gray-600",children:["Job ID: ",n.id.slice(-8)]})]})]}),(0,t.jsx)("span",{className:"px-3 py-1 rounded-full text-sm font-medium ".concat((e=>{switch(e){case"queued":return"text-yellow-600 bg-yellow-100";case"processing":return"text-blue-600 bg-blue-100";case"completed":return"text-green-600 bg-green-100";case"failed":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}})(n.status)),children:n.status.charAt(0).toUpperCase()+n.status.slice(1)})]}),("queued"===n.status||"processing"===n.status)&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-600 mb-1",children:[(0,t.jsx)("span",{children:"Progress"}),(0,t.jsxs)("span",{children:[n.progress,"%"]})]}),(0,t.jsx)("div",{className:"progress",children:(0,t.jsx)("div",{className:"progress-bar",style:{width:"".concat(n.progress,"%")}})}),n.estimatedCompletionTime&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Estimated completion: ",new Date(n.estimatedCompletionTime).toLocaleTimeString()]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-500",children:"Format:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-900",children:n.format.toUpperCase()})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-500",children:"Duration:"}),(0,t.jsxs)("span",{className:"ml-2 text-gray-900",children:[Math.floor(n.duration/60),"m ",n.duration%60,"s"]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-500",children:"Status:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-900 capitalize",children:n.status})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-500",children:"Files:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-900",children:n.artifacts.length})]})]}),"completed"===n.status&&n.artifacts.length>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h5",{className:"font-medium text-gray-700 mb-2",children:"Downloads"}),(0,t.jsx)("div",{className:"space-y-2",children:n.artifacts.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-medium text-gray-900",children:e.filename}),(0,t.jsxs)("div",{className:"text-sm text-gray-600",children:[(e.fileSize/1024/1024).toFixed(2)," MB • ",e.contentType]})]}),(0,t.jsx)("button",{onClick:()=>m(e.id),className:"btn-primary text-sm px-3 py-1",children:"Download"})]},e.id))})]}),"failed"===n.status&&n.logs.length>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h5",{className:"font-medium text-red-700 mb-2",children:"Error Details"}),(0,t.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:n.logs.filter(e=>"error"===e.level).slice(0,3).map(e=>(0,t.jsxs)("div",{className:"text-sm text-red-800",children:[(0,t.jsxs)("span",{className:"font-medium",children:[new Date(e.createdAt).toLocaleTimeString(),":"]}),(0,t.jsx)("span",{className:"ml-2",children:e.message})]},e.id))})]}),n.logs.length>0&&"failed"!==n.status&&(0,t.jsxs)("details",{className:"text-sm",children:[(0,t.jsxs)("summary",{className:"cursor-pointer font-medium text-gray-700 hover:text-gray-900",children:["View Logs (",n.logs.length,")"]}),(0,t.jsx)("div",{className:"mt-2 space-y-1 max-h-32 overflow-y-auto bg-gray-50 rounded p-2",children:n.logs.slice(0,10).map(e=>(0,t.jsxs)("div",{className:"flex items-start space-x-2 text-xs",children:[(0,t.jsx)("span",{className:"text-gray-500 whitespace-nowrap",children:new Date(e.createdAt).toLocaleTimeString()}),(0,t.jsx)("span",{className:"px-1 rounded text-xs ".concat("error"===e.level?"bg-red-100 text-red-800":"warn"===e.level?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"),children:e.level}),(0,t.jsx)("span",{className:"text-gray-700",children:e.message})]},e.id))})]})]})}):(0,t.jsx)("div",{className:"card",children:(0,t.jsx)("div",{className:"card-body",children:(0,t.jsxs)("div",{className:"animate-pulse",children:[(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-2"}),(0,t.jsx)("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})})})}function x(){var e,s;let{id:a}=(0,r.useRouter)().query,[n,x]=(0,l.useState)(""),[p,h]=(0,l.useState)({}),[g,u]=(0,l.useState)([]),{data:j}=(0,i.I)({queryKey:["templates"],queryFn:async()=>{let e=await fetch("/api/templates");if(!e.ok)throw Error("Failed to fetch templates");return e.json()}}),{data:v}=(0,i.I)({queryKey:["dataset",a],queryFn:async()=>({id:a,name:"Dataset ".concat(a),rowsEstimated:1e3,fileSize:1024e3}),enabled:!!a}),N=(0,d.n)({mutationFn:async e=>{let{format:s,templateId:t}=e,l=await fetch("/api/jobs/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({datasetId:a,templateId:t,format:s,theme:"utss-2025",customMapping:Object.keys(p).length>0?p:void 0})});if(!l.ok){var r;throw Error((null==(r=(await l.json()).error)?void 0:r.message)||"Export failed")}return l.json()},onSuccess:e=>{u(s=>[...s,e.jobId])}}),y=e=>{if(!n)return void alert("Please select a template first");N.mutate({format:e,templateId:n})};return((0,l.useState)(()=>{var e;if((null==j||null==(e=j.templates)?void 0:e.length)>0&&!n){let e=j.templates.find(e=>{var s;return null==(s=e.sourceHint)?void 0:s.toLowerCase().includes("sourcescrub")});x((null==e?void 0:e.id)||j.templates[0].id)}}),a)?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(c(),{children:[(0,t.jsx)("title",{children:"Preview Dataset - Edge Scraper Pro"}),(0,t.jsx)("meta",{name:"description",content:"Preview and export target list dataset"})]}),(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,t.jsx)("header",{className:"utss-header",children:(0,t.jsxs)("div",{className:"container",children:[(0,t.jsx)("h1",{children:"Target List Preview"}),(0,t.jsx)("p",{children:"Review → Export → Download"})]})}),(0,t.jsxs)("main",{className:"container py-8",children:[(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsxs)("nav",{className:"flex items-center space-x-2 text-sm",children:[(0,t.jsx)("a",{href:"/targets/new",className:"text-blue-600 hover:text-blue-800",children:"Target Lists"}),(0,t.jsx)("span",{className:"text-gray-400",children:"/"}),(0,t.jsx)("span",{className:"text-gray-600",children:"Preview"})]})}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8",children:[(0,t.jsx)("div",{className:"lg:col-span-2",children:(0,t.jsxs)("div",{className:"card",children:[(0,t.jsx)("div",{className:"card-header",children:(0,t.jsx)("h2",{children:"Dataset Information"})}),(0,t.jsx)("div",{className:"card-body",children:(0,t.jsxs)("dl",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Name"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900",children:null==v?void 0:v.name})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Estimated Rows"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900",children:null==v||null==(e=v.rowsEstimated)?void 0:e.toLocaleString()})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"File Size"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900",children:(null==v?void 0:v.fileSize)?"".concat((v.fileSize/1024/1024).toFixed(2)," MB"):"N/A"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),(0,t.jsx)("dd",{children:(0,t.jsx)("span",{className:"badge badge-success",children:"Ready for Export"})})]})]})})]})}),(0,t.jsx)("div",{children:(0,t.jsxs)("div",{className:"card",children:[(0,t.jsx)("div",{className:"card-header",children:(0,t.jsx)("h3",{children:"Export Options"})}),(0,t.jsxs)("div",{className:"card-body space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Mapping Template"}),(0,t.jsxs)("select",{value:n,onChange:e=>x(e.target.value),className:"w-full",children:[(0,t.jsx)("option",{value:"",children:"Select template..."}),null==j||null==(s=j.templates)?void 0:s.map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.name," v",e.version]},e.id))]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("button",{onClick:()=>y("xlsx"),disabled:!n||N.isPending,className:"btn-primary w-full",children:N.isPending?"Exporting...":"Export Excel (XLSX)"}),(0,t.jsx)("button",{onClick:()=>y("pdf"),disabled:!n||N.isPending,className:"btn-secondary w-full",children:N.isPending?"Exporting...":"Export PDF"})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-600 bg-gray-50 p-3 rounded",children:[(0,t.jsx)("p",{className:"font-medium mb-1",children:"Export Features:"}),(0,t.jsxs)("ul",{className:"space-y-1",children:[(0,t.jsx)("li",{children:"• UTSS-style formatting"}),(0,t.jsx)("li",{children:"• Data validation & transforms"}),(0,t.jsx)("li",{children:"• Excel injection protection"}),(0,t.jsx)("li",{children:"• Professional page layout"})]})]})]})]})})]}),g.length>0&&(0,t.jsxs)("div",{className:"mb-8",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"Export Jobs"}),(0,t.jsx)("div",{className:"space-y-4",children:g.map(e=>(0,t.jsx)(o,{jobId:e,onComplete:()=>{u(s=>s.filter(s=>s!==e))}},e))})]}),n&&(0,t.jsxs)("div",{className:"card",children:[(0,t.jsxs)("div",{className:"card-header",children:[(0,t.jsx)("h2",{children:"Data Preview"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Preview of how your data will appear in the export"})]}),(0,t.jsx)("div",{className:"card-body",children:(0,t.jsx)(m.A,{datasetId:a,templateId:n,customMapping:p,sampleSize:50})})]})]})]})]}):(0,t.jsx)("div",{children:"Loading..."})}},7635:(e,s,a)=>{"use strict";a.d(s,{A:()=>d});var t=a(7876),l=a(7914),r=a(1895),i=a(4232);function d(e){var s;let{datasetId:a,templateId:d,customMapping:n,sampleSize:c=50}=e,m=(0,i.useRef)(null),{data:o,isLoading:x,error:p}=(0,l.I)({queryKey:["preview",a,d,n,c],queryFn:async()=>{let e=await fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({datasetId:a,templateId:d,customMapping:n,sampleSize:c})});if(!e.ok){var s;throw Error((null==(s=(await e.json()).error)?void 0:s.message)||"Failed to load preview")}return e.json()}}),h=(0,r.Te)({count:(null==o?void 0:o.sampleRows.transformed.length)||0,getScrollElement:()=>m.current,estimateSize:()=>50});if(x)return(0,t.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Loading preview..."})]})});if(p)return(0,t.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,t.jsx)("h4",{className:"font-semibold text-red-900 mb-2",children:"Preview Error"}),(0,t.jsx)("p",{className:"text-red-800",children:p.message})]});if(!o)return null;let g=o.columns.target.filter(e=>Object.values(o.mapping).includes(e.name));return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"bg-blue-50 rounded-lg p-4",children:[(0,t.jsx)("h4",{className:"font-semibold text-blue-900",children:"Dataset"}),(0,t.jsx)("p",{className:"text-blue-800",children:o.dataset.name}),(0,t.jsxs)("p",{className:"text-sm text-blue-700",children:["~",null==(s=o.dataset.rowsEstimated)?void 0:s.toLocaleString()," rows"]})]}),(0,t.jsxs)("div",{className:"bg-green-50 rounded-lg p-4",children:[(0,t.jsx)("h4",{className:"font-semibold text-green-900",children:"Template"}),(0,t.jsx)("p",{className:"text-green-800",children:o.template.name}),(0,t.jsxs)("p",{className:"text-sm text-green-700",children:["v",o.template.version]})]}),(0,t.jsxs)("div",{className:"bg-purple-50 rounded-lg p-4",children:[(0,t.jsx)("h4",{className:"font-semibold text-purple-900",children:"Mapping Quality"}),(0,t.jsx)("div",{className:"flex items-center space-x-2",children:(0,t.jsxs)("span",{className:"badge ".concat(o.mappingStats.mappingComplete?"badge-success":"badge-warning"),children:[o.mappingStats.mappedHeaders,"/",o.mappingStats.totalHeaders," mapped"]})}),(0,t.jsxs)("p",{className:"text-sm text-purple-700",children:[o.mappingStats.requiredFieldsMapped,"/",o.mappingStats.requiredFieldsTotal," required"]})]})]}),(!o.mappingStats.mappingComplete||o.unmappedHeaders.length>0)&&(0,t.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[(0,t.jsx)("h4",{className:"font-semibold text-yellow-900 mb-2",children:"Mapping Warnings"}),(0,t.jsxs)("div",{className:"space-y-2 text-sm",children:[!o.mappingStats.mappingComplete&&(0,t.jsx)("p",{className:"text-yellow-800",children:"• Some required fields are not mapped and may result in incomplete data"}),o.unmappedHeaders.length>0&&(0,t.jsxs)("p",{className:"text-yellow-800",children:["• Unmapped columns: ",o.unmappedHeaders.join(", ")]})]})]}),(0,t.jsxs)("div",{className:"card",children:[(0,t.jsxs)("div",{className:"card-header",children:[(0,t.jsxs)("h3",{children:["Data Preview (",o.sampleRows.transformed.length," sample rows)"]}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Showing transformed data as it will appear in the final export"})]}),(0,t.jsx)("div",{className:"card-body p-0",children:(0,t.jsx)("div",{ref:m,className:"h-96 overflow-auto",children:(0,t.jsxs)("div",{style:{height:"".concat(h.getTotalSize(),"px"),width:"100%",position:"relative"},children:[(0,t.jsx)("div",{className:"sticky top-0 z-10 bg-gray-50 border-b",children:(0,t.jsx)("div",{className:"flex",children:g.map(e=>(0,t.jsxs)("div",{className:"flex-1 min-w-32 px-4 py-3 text-sm font-medium text-gray-900 border-r",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("span",{children:e.name}),e.required&&(0,t.jsx)("span",{className:"badge badge-error text-xs",children:"Required"})]}),e.transform&&(0,t.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Transform: ",e.transform]})]},e.name))})}),h.getVirtualItems().map(e=>{let s=o.sampleRows.transformed[e.index];return(0,t.jsx)("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"".concat(e.size,"px"),transform:"translateY(".concat(e.start,"px)")},className:"flex ".concat(e.index%2==0?"bg-white":"bg-gray-50"," border-b hover:bg-blue-50"),children:g.map(e=>{var a;return(0,t.jsx)("div",{className:"flex-1 min-w-32 px-4 py-3 text-sm border-r",children:(0,t.jsx)("div",{className:"truncate",title:null==(a=s[e.name])?void 0:a.toString(),children:null!==s[e.name]&&void 0!==s[e.name]?s[e.name].toString():(0,t.jsx)("span",{className:"text-gray-400 italic",children:e.defaultValue||"N/A"})})},e.name)})},e.index)})]})})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,t.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:o.sampleRows.transformed.length}),(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Sample Rows"})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,t.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:g.length}),(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Mapped Fields"})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,t.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:o.mappingStats.requiredFieldsMapped}),(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Required Fields"})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,t.jsxs)("div",{className:"text-2xl font-bold text-gray-900",children:[Math.round(o.mappingStats.mappedHeaders/o.mappingStats.totalHeaders*100),"%"]}),(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Coverage"})]})]})]})}},9210:(e,s,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/targets/[id]/preview",function(){return a(6229)}])}},e=>{e.O(0,[737,636,593,792],()=>e(e.s=9210)),_N_E=e.O()}]);