"use strict";exports.id=875,exports.ids=[875],exports.modules={688:(a,b,c)=>{let{JSDOM:d}=c(2325),e={mainContent:[".main-content",".content",".directory-content",".supplier-directory",'[class*="directory"]','[class*="supplier"]','[class*="company"]',"main","article",'[role="main"]','[role="article"]'],companyTables:["table",".table",".data-table",".company-table",".supplier-table",".directory-table",'[class*="table"]','[class*="listing"]',".view-all-companies",".company-list",".supplier-list"],companyRows:["tr",".company-row",".supplier-row",".listing-row",'[class*="company"]','[class*="supplier"]','[class*="listing"]'],companyName:["td:first-child",".company-name",".supplier-name",".name",'[class*="name"]',"strong","b","a"],contactInfo:["td:nth-child(2)",".contact",".address",".contact-info",'[class*="contact"]','[class*="address"]','[class*="info"]'],website:["td:last-child",".website",".url",".web",".site",'[class*="website"]','[class*="url"]','[class*="web"]','a[href*="http"]','a[href*="www"]']},f={"d2pbuyersguide.com":{name:"Design 2 Part Supplier Directory",primaryContentSelector:".view-all-companies, .main-content",companyTableSelector:"table",companyRowSelector:"tr",nameColumn:0,contactColumn:1,websiteColumn:2,excludeSelectors:[".advertisement",".ad",".sidebar",".featured"],dataPatterns:{companyName:/^[A-Z][A-Z\s&.,-]+$/,address:/^\d+.*(?:St|Ave|Rd|Blvd|Dr|Way|Ln|Ct|Pl|Pkwy)\.?\s+.*,\s*[A-Z]{2}\s+\d{5}/,website:/^(www\.)?[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.[a-zA-Z]{2,}$/}},"thomasnet.com":{name:"ThomasNet Supplier Directory",primaryContentSelector:".search-results, .supplier-results",companyTableSelector:".supplier-card, .company-card",companyRowSelector:".supplier-card, .company-card",nameColumn:"name",contactColumn:"address",websiteColumn:"website",excludeSelectors:[".advertisement",".ad",".promoted"]},"globalspec.com":{name:"GlobalSpec Supplier Directory",primaryContentSelector:".search-results, .supplier-listing",companyTableSelector:".supplier-item, .company-item",companyRowSelector:".supplier-item, .company-item",nameColumn:"name",contactColumn:"location",websiteColumn:"website",excludeSelectors:[".advertisement",".ad",".sponsored"]}};class g{constructor(){this.debug=!0}extractSupplierData(a,b=""){let c=this.getSiteConfig(b),d=this.performSupplierExtraction(a,c);return{companies:d.companies,metadata:d.metadata,method:d.method,score:d.score,debug:d.debug,validation:this.validateSupplierContent(d.companies)}}getSiteConfig(a){try{let b=new URL(a).hostname.toLowerCase();for(let[a,c]of Object.entries(f))if(b.includes(a))return{...c,domain:a}}catch(a){}return f["d2pbuyersguide.com"]}performSupplierExtraction(a,b){let c=a.cloneNode(!0);try{this.cleanDocumentForSuppliers(c,b);let a=this.extractCompanyData(c,b),d=this.extractMetadata(c,b),e=this.scoreExtraction(a,d);return{companies:a,metadata:d,method:"supplier-directory",score:e,debug:{companiesFound:a.length,siteConfig:b.domain,extractionMethod:"table-based"}}}finally{this.cleanupDOMClone(c)}}cleanDocumentForSuppliers(a,b){["script","style","noscript","iframe","object","embed",'nav:not([class*="content"]):not([id*="content"])','footer:not([class*="content"]):not([id*="content"])','header:not([class*="content"]):not([id*="content"])','aside:not([class*="content"]):not([class*="supplier"])','[class*="advertisement"]','[class*="ads"]','[id*="ads"]','[class*="social"]:not([class*="content"])','[class*="share"]:not([class*="content"])',...b.excludeSelectors].forEach(b=>{try{a.querySelectorAll(b).forEach(a=>a.remove())}catch(a){}})}extractCompanyData(a,b){let c=[];if(this.findCompanyTables(a,b).forEach(a=>{try{let d=this.parseCompanyTable(a,b);c.push(...d)}catch(a){this.debug&&console.warn("Error parsing company table:",a.message)}}),0===c.length){let d=this.extractCompaniesAlternative(a,b);c.push(...d)}return this.deduplicateCompanies(c)}findCompanyTables(a,b){let c=[];if(b.companyTableSelector)try{let d=a.querySelectorAll(b.companyTableSelector);c.push(...Array.from(d))}catch(a){}return e.companyTables.forEach(b=>{try{let d=a.querySelectorAll(b);c.push(...Array.from(d))}catch(a){}}),c}parseCompanyTable(a,b){let c=[],d=a.querySelectorAll("tr"),e=0;if(d.length>0){let a=d[0].textContent.toLowerCase();(a.includes("name")||a.includes("company")||a.includes("contact")||a.includes("website"))&&(e=1)}for(let a=e;a<d.length;a++){let e=d[a].querySelectorAll("td, th");if(!(e.length<2))try{let a=this.extractCompanyFromRow(e,b);a&&a.name&&c.push(a)}catch(b){this.debug&&console.warn(`Error parsing row ${a}:`,b.message)}}return c}extractCompanyFromRow(a,b){let c={name:"",contact:"",website:"",rawData:{}},d="number"==typeof b.nameColumn?b.nameColumn:this.findColumnIndex(a,["name","company","supplier"]);d>=0&&a[d]&&(c.name=this.cleanText(a[d].textContent));let e="number"==typeof b.contactColumn?b.contactColumn:this.findColumnIndex(a,["contact","address","location","info"]);e>=0&&a[e]&&(c.contact=this.cleanText(a[e].textContent));let f="number"==typeof b.websiteColumn?b.websiteColumn:this.findColumnIndex(a,["website","url","web","site"]);if(f>=0&&a[f]){let b=this.cleanText(a[f].textContent),d=a[f].querySelector("a[href]");d?c.website=this.normalizeWebsite(d.href):b&&(c.website=this.normalizeWebsite(b))}return c.rawData={cellCount:a.length,cellTexts:Array.from(a).map(a=>this.cleanText(a.textContent))},c}findColumnIndex(a,b){for(let c=0;c<a.length;c++){let d=a[c].textContent.toLowerCase();if(b.some(a=>d.includes(a)))return c}return -1}extractCompaniesAlternative(a,b){let c=[];return a.querySelectorAll('.company-card, .supplier-card, .listing-item, [class*="company"], [class*="supplier"]').forEach(a=>{try{let d=this.extractCompanyFromElement(a,b);d&&d.name&&c.push(d)}catch(a){this.debug&&console.warn("Error extracting company from element:",a.message)}}),c}extractCompanyFromElement(a,b){let c={name:"",contact:"",website:"",rawData:{}};for(let b of e.companyName){let d=a.querySelector(b);if(d&&d.textContent.trim()){c.name=this.cleanText(d.textContent);break}}for(let b of e.contactInfo){let d=a.querySelector(b);if(d&&d.textContent.trim()){c.contact=this.cleanText(d.textContent);break}}for(let b of e.website){let d=a.querySelector(b);if(d){if("A"===d.tagName&&d.href)c.website=this.normalizeWebsite(d.href);else{let a=d.querySelector("a[href]");a&&a.href?c.website=this.normalizeWebsite(a.href):d.textContent.trim()&&(c.website=this.normalizeWebsite(d.textContent))}break}}return c}extractMetadata(a,b){let c={title:"",description:"",totalCompanies:0,siteName:b.name||"Unknown",extractedAt:new Date().toISOString()},d=a.querySelector("title, h1, .page-title");d&&(c.title=this.cleanText(d.textContent));let e=a.querySelector('meta[name="description"], .description, .page-description');return e&&(c.description=this.cleanText(e.textContent||e.getAttribute("content")||"")),c}scoreExtraction(a,b){let c;return c=0+Math.min(10*a.length,100)+20*a.filter(a=>a.name&&a.contact&&a.website).length,b.title&&(c+=10),b.description&&(c+=10),Math.max(0,Math.min(c-=5*a.filter(a=>!a.name).length,200))}cleanText(a){return a?a.replace(/[\r\n\t]+/g," ").replace(/\s+/g," ").trim():""}normalizeWebsite(a){if(!a)return"";let b=a.trim();return b.startsWith("http://")||b.startsWith("https://")||(b="https://"+b),b}deduplicateCompanies(a){let b=[],c=new Set;return a.forEach(a=>{if(!a.name)return;let d=a.name.toLowerCase().replace(/[^a-z0-9]/g,"");c.has(d)||(c.add(d),b.push(a))}),b}validateSupplierContent(a){if(!a||0===a.length)return{isValid:!1,score:0,reasons:["No companies found"]};let b={},c=0;Object.entries({hasCompanies:a=>a.length>0,hasNames:a=>a.some(a=>a.name&&a.name.length>2),hasContactInfo:a=>a.some(a=>a.contact&&a.contact.length>5),hasWebsites:a=>a.some(a=>a.website&&a.website.length>5),validNames:a=>a.filter(a=>a.name&&/^[A-Z]/.test(a.name)).length>0,validWebsites:a=>a.filter(a=>a.website&&/https?:\/\//.test(a.website)).length>0}).forEach(([d,e])=>{let f=e(a);b[d]=f,f&&(c+=1)});let d=c>=4,e=Object.entries(b).filter(([a,b])=>!b).map(([a,b])=>a);return{isValid:d,score:c,results:b,reasons:e}}cleanupDOMClone(a){try{for(;a.firstChild;)a.removeChild(a.firstChild);void 0!==a.textContent&&(a.textContent=""),"undefined"!=typeof global&&global.gc&&global.gc()}catch(a){this.debug&&console.warn("DOM cleanup warning:",a.message)}}}a.exports={SupplierDirectoryExtractor:g,SUPPLIER_SELECTORS:e,SUPPLIER_SITE_CONFIGS:f}},995:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{B8:()=>i,Cw:()=>g,eC:()=>j,lo:()=>k});var e=c(2971),f=a([e]);(e=(f.then?(await f)():f)[0]).z.object({urls:e.z.array(e.z.string().url()).min(1).max(1500),options:e.z.object({concurrency:e.z.number().min(1).max(20).optional().default(3),delayMs:e.z.number().min(0).max(1e4).optional().default(1e3),timeout:e.z.number().min(1e3).max(6e4).optional().default(3e4),maxRetries:e.z.number().min(0).max(5).optional().default(3)}).optional().default({})}),e.z.object({content:e.z.string(),filename:e.z.string(),contentType:e.z.string(),options:e.z.object({concurrency:e.z.number().min(1).max(20).optional().default(3),delayMs:e.z.number().min(0).max(1e4).optional().default(1e3),timeout:e.z.number().min(1e3).max(6e4).optional().default(3e4),maxRetries:e.z.number().min(0).max(5).optional().default(3)}).optional().default({})});let h=e.z.object({success:e.z.boolean(),data:e.z.any().optional(),error:e.z.string().optional(),metadata:e.z.object({url:e.z.string(),extractedAt:e.z.string(),processingTime:e.z.number(),mode:e.z.string(),version:e.z.string()})}),i=e.z.object({results:e.z.array(h),summary:e.z.object({total:e.z.number(),successful:e.z.number(),failed:e.z.number(),averageTime:e.z.number(),errors:e.z.array(e.z.object({url:e.z.string(),error:e.z.string(),category:e.z.string()}))}),metadata:e.z.object({jobId:e.z.string(),mode:e.z.string(),startTime:e.z.string(),endTime:e.z.string(),duration:e.z.number()})});class j extends Error{constructor(a,b,c){super(a),this.code=b,this.details=c,this.name="ModeError"}}class k extends j{constructor(a){super(`Mode not found: ${a}`,"MODE_NOT_FOUND",{modeId:a}),this.name="ModeNotFoundError"}}function g(a){return a&&"string"==typeof a.id&&"string"==typeof a.label&&"string"==typeof a.version&&a.inputSchema&&a.outputSchema&&a.uiHints&&"function"==typeof a.run}d()}catch(a){d(a)}})},1034:(a,b,c)=>{let d=c(9021).promises,e=c(3873),{randomUUID:f}=c(5511),g=c(4339);class h{constructor(a={}){this.options={logDirectory:a.logDirectory||"./logs",jobId:a.jobId||f(),enableFileLogging:!1!==a.enableFileLogging,enableConsoleLogging:!1!==a.enableConsoleLogging,maxLogFileSize:a.maxLogFileSize||0x6400000,rotateOnSize:!1!==a.rotateOnSize,...a},this.logger=g("structured-logger"),this.logFilePath=e.join(this.options.logDirectory,`${this.options.jobId}.log`),this.summaryFilePath=e.join(this.options.logDirectory,`${this.options.jobId}-summary.json`),this.counters={total_requests:0,successful_requests:0,failed_requests:0,canonicalized_requests:0,robots_blocked:0,pagination_discovered:0,error_categories:{},response_times:[],start_time:Date.now(),end_time:null},this.initializeLogDirectory()}async initializeLogDirectory(){try{await d.mkdir(this.options.logDirectory,{recursive:!0}),this.logger.debug({logDirectory:this.options.logDirectory},"Log directory initialized")}catch(a){this.logger.error({error:a.message},"Failed to create log directory")}}async logRequest(a){let b={timestamp:new Date().toISOString(),job_id:this.options.jobId,event_type:"request",...a};this.counters.total_requests++,a.success?this.counters.successful_requests++:(this.counters.failed_requests++,a.error_class&&(this.counters.error_categories[a.error_class]=(this.counters.error_categories[a.error_class]||0)+1)),a.canonicalized&&this.counters.canonicalized_requests++,a.robots_blocked&&this.counters.robots_blocked++,a.pagination_discovered&&this.counters.pagination_discovered++,a.response_time_ms&&this.counters.response_times.push(a.response_time_ms),await this.writeLogEntry(b)}async logPaginationDiscovery(a){let b={timestamp:new Date().toISOString(),job_id:this.options.jobId,event_type:"pagination_discovery",...a};await this.writeLogEntry(b)}async logCanonicalization(a){let b={timestamp:new Date().toISOString(),job_id:this.options.jobId,event_type:"canonicalization",...a};await this.writeLogEntry(b)}async logBatchSummary(a){this.counters.end_time=Date.now();let b={timestamp:new Date().toISOString(),job_id:this.options.jobId,event_type:"batch_summary",duration_ms:this.counters.end_time-this.counters.start_time,...this.counters,...a};await this.writeLogEntry(b),await this.writeSummaryFile(b)}createRequestLogEntry(a){let b={original_url:a.originalUrl,resolved_url:a.resolvedUrl,success:!!a.response&&a.response.ok,response_time_ms:a.responseTime,robots_allowed:a.robotsAllowed,canonicalized:!!a.canonicalizationResult?.success,pagination_discovered:!1,redirect_chain:[]};return a.response&&(b.status_code=a.response.status,b.status_text=a.response.statusText,b.content_type=a.response.headers.get("content-type"),b.content_length=a.response.headers.get("content-length"),b.server=a.response.headers.get("server"),b.cache_control=a.response.headers.get("cache-control")),a.canonicalizationResult&&(b.canonicalization={success:a.canonicalizationResult.success,attempts:a.canonicalizationResult.attempts?.length||0,total_response_time_ms:a.canonicalizationResult.totalResponseTime,redirect_chain:a.canonicalizationResult.redirectChain||[]},b.redirect_chain=a.canonicalizationResult.redirectChain||[]),!b.success&&(a.error?(b.error=a.error,b.error_code=a.errorCode,b.error_class=this.categorizeErrorForLogging(a)):a.response&&(b.error_class=`http_${a.response.status}`,b.error=`HTTP ${a.response.status}: ${a.response.statusText}`)),b}categorizeErrorForLogging(a){let b=a.error,c=a.errorCode,d=a.status;return"ENOTFOUND"===c||"EAI_NODATA"===c||"EAI_NONAME"===c?"dns_error":"ECONNREFUSED"===c||"ECONNRESET"===c||"ENETUNREACH"===c?"network_error":"ETIMEDOUT"===c||b?.includes("timeout")?"timeout_error":c?.includes("CERT_")||b?.includes("certificate")||b?.includes("SSL")?"ssl_error":"BLOCKED_BY_ROBOTS"===c?"blocked_by_robots":404===d?"http_404":403===d?"http_403":401===d?"http_401":429===d?"rate_limit":503===d&&b?.includes("cloudflare")?"anti_bot_challenge":d>=500?"server_error":d>=400?"client_error":"unknown"}async writeLogEntry(a){let b=JSON.stringify(a)+"\n";if(this.options.enableConsoleLogging&&("request"===a.event_type&&a.success?this.logger.info({url:a.resolved_url,status:a.status_code,time:a.response_time_ms,canonicalized:a.canonicalized},"Request successful"):"request"!==a.event_type||a.success||this.logger.error({url:a.original_url,error:a.error,error_class:a.error_class,time:a.response_time_ms},"Request failed")),this.options.enableFileLogging)try{this.options.rotateOnSize&&await this.checkAndRotateLog(),await d.appendFile(this.logFilePath,b)}catch(a){this.logger.error({error:a.message},"Failed to write log entry to file")}}async writeSummaryFile(a){try{let b=this.counters.response_times,c={...a,response_time_stats:b.length>0?{min:Math.min(...b),max:Math.max(...b),avg:b.reduce((a,b)=>a+b,0)/b.length,median:b.sort()[Math.floor(b.length/2)]}:null};await d.writeFile(this.summaryFilePath,JSON.stringify(c,null,2)),this.logger.info({summaryFile:this.summaryFilePath},"Summary file written")}catch(a){this.logger.error({error:a.message},"Failed to write summary file")}}async checkAndRotateLog(){try{if((await d.stat(this.logFilePath)).size>this.options.maxLogFileSize){let a=`${this.logFilePath}.${Date.now()}`;await d.rename(this.logFilePath,a),this.logger.info({rotatedPath:a},"Log file rotated")}}catch(a){"ENOENT"!==a.code&&this.logger.warn({error:a.message},"Failed to check log file size")}}getStats(){return{...this.counters,log_file:this.logFilePath,summary_file:this.summaryFilePath}}async finalize(){let a={job_completed:!0,final_stats:this.getStats()};await this.logBatchSummary(a),this.logger.info({jobId:this.options.jobId},"Structured logging finalized")}}a.exports={StructuredLogger:h}},1312:(a,b,c)=>{let{chromium:d}=c(5883);a.exports={renderSpaPage:async function(a){let b=await d.launch({headless:!0});try{let c=await b.newPage();return await c.goto(a,{waitUntil:"networkidle"}),await c.content()}finally{await b.close()}}}},2101:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{A:()=>h});var e=c(2971),f=a([e]);let g=(e=(f.then?(await f)():f)[0]).z.object({HTTP_DEADLINE_MS:e.z.coerce.number().int().positive().default(1e4),HTTP_MAX_RETRIES:e.z.coerce.number().int().min(0).default(3),HTTP_RATE_LIMIT_PER_SEC:e.z.coerce.number().int().min(1).default(5),HTTP_MAX_CONCURRENCY:e.z.coerce.number().int().min(1).default(2),HTTP_CIRCUIT_BREAKER_THRESHOLD:e.z.coerce.number().int().min(1).default(5),HTTP_CIRCUIT_BREAKER_RESET_MS:e.z.coerce.number().int().positive().default(3e4),HOST_LIMIT__DEFAULT__RPS:e.z.coerce.number().positive().default(1),HOST_LIMIT__DEFAULT__BURST:e.z.coerce.number().int().min(1).default(2),HOST_LIMIT__www_pro_football_reference_com__RPS:e.z.coerce.number().positive().default(.5),HOST_LIMIT__www_pro_football_reference_com__BURST:e.z.coerce.number().int().min(1).default(1),HTTP_RETRY_BUDGET_PER_BATCH:e.z.coerce.number().int().min(1).default(10),HTTP_BASE_BACKOFF_MS:e.z.coerce.number().int().positive().default(1e3),HTTP_MAX_BACKOFF_MS:e.z.coerce.number().int().positive().default(3e4),HTTP_JITTER_FACTOR:e.z.coerce.number().min(0).max(1).default(.1),HTTP_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS:e.z.coerce.number().int().min(1).default(3),HTTP_CONNECT_TIMEOUT_MS:e.z.coerce.number().int().positive().default(5e3),HTTP_READ_TIMEOUT_MS:e.z.coerce.number().int().positive().default(1e4),HTTP_INTER_REQUEST_DELAY_MS:e.z.coerce.number().int().min(0).default(100)}).parse(process.env),h={DEFAULT_TIMEOUT_MS:g.HTTP_DEADLINE_MS,MAX_RETRIES:g.HTTP_MAX_RETRIES,RATE_LIMIT_PER_SEC:g.HTTP_RATE_LIMIT_PER_SEC,MAX_CONCURRENCY:g.HTTP_MAX_CONCURRENCY,CIRCUIT_BREAKER_THRESHOLD:g.HTTP_CIRCUIT_BREAKER_THRESHOLD,CIRCUIT_BREAKER_RESET_MS:g.HTTP_CIRCUIT_BREAKER_RESET_MS,HOST_LIMITS:{"www.pro-football-reference.com":{rps:g.HOST_LIMIT__www_pro_football_reference_com__RPS,burst:g.HOST_LIMIT__www_pro_football_reference_com__BURST},default:{rps:g.HOST_LIMIT__DEFAULT__RPS,burst:g.HOST_LIMIT__DEFAULT__BURST}},RETRY_BUDGET_PER_BATCH:g.HTTP_RETRY_BUDGET_PER_BATCH,BASE_BACKOFF_MS:g.HTTP_BASE_BACKOFF_MS,MAX_BACKOFF_MS:g.HTTP_MAX_BACKOFF_MS,JITTER_FACTOR:g.HTTP_JITTER_FACTOR,CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS:g.HTTP_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS,CONNECT_TIMEOUT_MS:g.HTTP_CONNECT_TIMEOUT_MS,READ_TIMEOUT_MS:g.HTTP_READ_TIMEOUT_MS,INTER_REQUEST_DELAY_MS:g.HTTP_INTER_REQUEST_DELAY_MS};d()}catch(a){d(a)}})},2232:(a,b,c)=>{let{URL:d}=c(9551),{JSDOM:e}=c(2325),f=c(4339);class g{constructor(a={}){this.logger=f("pagination-discovery"),this.options={paginationMode:a.paginationMode||"auto",maxConsecutive404s:a.maxConsecutive404s||3,maxPagesToDiscover:a.maxPagesToDiscover||100,letterIndexes:a.letterIndexes||["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],paginationSelectors:a.paginationSelectors||['a[rel="next"]',"nav.pagination a","ul.pagination a",".pagination a",'[aria-label*="Next"]','[aria-label*="next"]','a:contains("Next")','a:contains("›")','a:contains("→")'],...a},this.discoveryCache=new Map,this.cacheMaxAge=9e5}extractPaginationFromHtml(a,b){try{let c=new e(a).window.document,f={hasNext:!1,nextUrl:null,pageNumbers:[],totalPages:null,currentPage:null},g=c.querySelector('a[rel="next"]');if(g&&g.href&&(f.hasNext=!0,f.nextUrl=new d(g.href,b).toString(),this.logger.debug({nextUrl:f.nextUrl},'Found rel="next" link')),!f.hasNext)for(let a of this.options.paginationSelectors){for(let e of c.querySelectorAll(a)){let c=e.textContent?.trim().toLowerCase(),g=e.href;if(g&&(c?.includes("next")||"›"===c||"→"===c)){f.hasNext=!0,f.nextUrl=new d(g,b).toString(),this.logger.debug({selector:a,nextUrl:f.nextUrl,text:c},"Found next link via selector");break}}if(f.hasNext)break}let h=c.querySelector(".pagination, nav.pagination, ul.pagination");if(h){for(let a of h.querySelectorAll("a")){let b=a.textContent?.trim(),c=parseInt(b);!isNaN(c)&&c>0&&f.pageNumbers.push(c)}if(f.pageNumbers.length>0){f.totalPages=Math.max(...f.pageNumbers);let a=h.querySelector('.active, .current, [aria-current="page"]');if(a){let b=parseInt(a.textContent?.trim());isNaN(b)||(f.currentPage=b)}}}let i=(c.body.textContent||"").match(/page\s+(\d+)\s+of\s+(\d+)/i);return i&&(f.currentPage=parseInt(i[1]),f.totalPages=parseInt(i[2]),this.logger.debug({currentPage:f.currentPage,totalPages:f.totalPages},"Found page info from text")),f}catch(a){return this.logger.warn({error:a.message,baseUrl:b},"Failed to extract pagination from HTML"),{hasNext:!1,nextUrl:null,pageNumbers:[],totalPages:null,currentPage:null}}}async discoverPagination(a,b){let c=this.extractUrlPattern(a),d=this.discoveryCache.get(c);if(d&&Date.now()-d.timestamp<this.cacheMaxAge)return this.logger.debug({baseUrl:a,pattern:c},"Using cached pagination discovery"),d.result;this.logger.info({baseUrl:a,mode:this.options.paginationMode},"Starting pagination discovery");let e={baseUrl:a,pattern:c,mode:this.options.paginationMode,success:!1,validUrls:[],totalPages:null,letterIndexes:[],error:null,discoveryTime:Date.now()};try{if("auto"===this.options.paginationMode){let c=await this.discoverRangePagination(a,b);if(c.success&&c.validUrls.length>0)Object.assign(e,c),e.mode="range";else{this.logger.info({baseUrl:a},"Range pagination failed, trying letter-based discovery");let c=await this.discoverLetterPagination(a,b);Object.assign(e,c),e.mode="letters"}}else if("range"===this.options.paginationMode){let c=await this.discoverRangePagination(a,b);Object.assign(e,c)}else if("letters"===this.options.paginationMode){let c=await this.discoverLetterPagination(a,b);Object.assign(e,c)}return e.success&&this.discoveryCache.set(c,{result:{...e},timestamp:Date.now()}),this.logger.info({baseUrl:a,mode:e.mode,success:e.success,validUrls:e.validUrls.length,totalPages:e.totalPages},"Pagination discovery completed"),e}catch(b){return e.error=b.message,this.logger.error({baseUrl:a,error:b.message},"Pagination discovery failed"),e}}async discoverRangePagination(a,b){let c={success:!1,validUrls:[],totalPages:null,error:null};try{let d=a;this.extractUrlPattern(a).includes("/page/")||(d=a.replace(/\/?$/,"/page/1")),this.logger.debug({startUrl:d},"Fetching first page for pagination analysis");let e=await b(d,{method:"GET",timeout:1e4});if(!e.ok)return c.error=`First page returned ${e.status}`,c;let f=await e.text(),g=this.extractPaginationFromHtml(f,d);if(c.validUrls.push(d),g.totalPages&&g.totalPages>1){c.totalPages=g.totalPages;let a=d.replace(/\/page\/\d+/,"/page/");for(let b=2;b<=Math.min(g.totalPages,this.options.maxPagesToDiscover);b++)c.validUrls.push(`${a}${b}`);return c.success=!0,this.logger.info({totalPages:c.totalPages,generatedUrls:c.validUrls.length},"Generated URLs from total pages"),c}let h=2,i=0,j=d.replace(/\/page\/\d+/,"/page/");for(;i<this.options.maxConsecutive404s&&c.validUrls.length<this.options.maxPagesToDiscover;){let a=`${j}${h}`;try{let d=await b(a,{method:"HEAD",timeout:5e3});d.ok?(c.validUrls.push(a),i=0,this.logger.debug({pageUrl:a,status:d.status},"Found valid page")):404===d.status?(i++,this.logger.debug({pageUrl:a,consecutive404s:i},"Page returned 404")):(c.validUrls.push(a),i=0,this.logger.debug({pageUrl:a,status:d.status},"Found page with non-200 status"))}catch(b){i++,this.logger.debug({pageUrl:a,error:b.message,consecutive404s:i},"Page request failed")}h++,await new Promise(a=>setTimeout(a,100))}return c.validUrls.length>1&&(c.success=!0,c.totalPages=c.validUrls.length),c}catch(a){return c.error=a.message,c}}async discoverLetterPagination(a,b){let c={success:!1,validUrls:[],letterIndexes:[],error:null};try{let d=a;if(d.includes("/filter/all/"))d=d.replace("/filter/all/","/filter/{letter}/");else{if(!d.includes("/all/"))return c.error="Could not identify letter substitution pattern",c;d=d.replace("/all/","/{letter}/")}for(let a of(this.logger.debug({basePattern:d},"Trying letter-based pagination"),this.options.letterIndexes)){let e=d.replace("{letter}",a);try{if((await b(e,{method:"HEAD",timeout:5e3})).ok&&(c.validUrls.push(e),c.letterIndexes.push(a),this.logger.debug({letter:a,letterUrl:e},"Found valid letter index"),e.includes("/page/"))){let a=await this.discoverLetterPages(e,b);c.validUrls.push(...a)}}catch(b){this.logger.debug({letter:a,error:b.message},"Letter index failed")}if(await new Promise(a=>setTimeout(a,150)),c.letterIndexes.length>=10){this.logger.info({foundLetters:c.letterIndexes.length},"Limiting letter discovery");break}}return c.letterIndexes.length>0&&(c.success=!0),c}catch(a){return c.error=a.message,c}}async discoverLetterPages(a,b){let c=[];try{let d=a.replace(/\/page\/\d+/,"/page/"),e=2,f=0;for(;f<2&&c.length<5;){let a=`${d}${e}`;try{let d=await b(a,{method:"HEAD",timeout:3e3});d.ok?(c.push(a),f=0):404===d.status&&f++}catch(a){f++}e++,await new Promise(a=>setTimeout(a,100))}}catch(b){this.logger.debug({letterUrl:a,error:b.message},"Failed to discover letter pages")}return c}extractUrlPattern(a){try{let b=new d(a);return b.origin+b.pathname.replace(/\/page\/\d+/,"/page/*")+b.search}catch(b){return a}}getStats(){return{cacheSize:this.discoveryCache.size,cacheMaxAge:this.cacheMaxAge}}clearCache(){this.discoveryCache.clear(),this.logger.debug("Cleared pagination discovery cache")}}a.exports={PaginationDiscovery:g}},2256:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>j,jobs:()=>l});var e=c(5586),f=c(6685),g=c(6980),h=c(1835),i=a([f,g]);[f,g]=i.then?(await i)():i;try{(0,g.lM)()}catch(a){console.error("Failed to initialize modes:",a)}let k=(0,e.createLogger)("api-scrape-start"),l=new Map;async function j(a,b){let c={"news-articles":"news",sports:"sports","supplier-directory":"companies"};if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{mode:d,input:e}=a.body;if(!d||!e)return b.status(400).json({error:"Mode and input are required"});let f=c[d]||d,g=await (0,h.G7)({...a,body:{taskName:f,input:e}},b);return c[d]&&k.warn("Legacy mode used, consider migrating to new task API",{legacyMode:d,newTaskName:f,endpoint:"/api/tasks/start"}),g}catch(a){k.error("Start job API error",{error:a instanceof Error?a.message:"Unknown error"}),b.status(500).json({error:"Internal server error"})}}d()}catch(a){d(a)}})},2803:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{a:()=>m});var e=c(2971),f=c(2325),g=c(995),h=c(5586),i=c(5614),j=a([e,g,i]);[e,g,i]=j.then?(await j)():j;let k=e.z.object({urls:e.z.array(e.z.string().url()).min(1).max(1500),options:e.z.object({concurrency:e.z.number().min(1).max(20).optional().default(5),delayMs:e.z.number().min(0).max(1e4).optional().default(500),timeout:e.z.number().min(1e3).max(6e4).optional().default(15e3),maxRetries:e.z.number().min(0).max(5).optional().default(2),extractContent:e.z.boolean().optional().default(!1),extractImages:e.z.boolean().optional().default(!1),maxContentLength:e.z.number().min(100).max(5e4).optional().default(5e3),dateFormat:e.z.enum(["iso","timestamp","human"]).optional().default("iso")}).optional().default({})}),l=g.B8.extend({results:e.z.array(e.z.object({url:e.z.string(),success:e.z.boolean(),data:e.z.object({title:e.z.string().optional(),byline:e.z.string().optional(),author:e.z.string().optional(),publishDate:e.z.string().optional(),modifiedDate:e.z.string().optional(),excerpt:e.z.string().optional(),content:e.z.string().optional(),wordCount:e.z.number().optional(),readingTime:e.z.number().optional(),tags:e.z.array(e.z.string()).optional(),category:e.z.string().optional(),images:e.z.array(e.z.object({src:e.z.string(),alt:e.z.string().optional(),caption:e.z.string().optional(),width:e.z.number().optional(),height:e.z.number().optional()})).optional(),metadata:e.z.object({extractedAt:e.z.string(),confidence:e.z.number(),source:e.z.string(),language:e.z.string().optional()})}).optional(),error:e.z.string().optional(),category:e.z.string().optional(),responseTime:e.z.number().optional(),canonicalized:e.z.boolean().optional()}))});class m{async run(a,b){this.logger.info("Starting news articles extraction",{jobId:b.jobId,urlCount:a.urls.length,options:a.options});try{let c=new i.Z({concurrency:a.options?.concurrency||5,delayMs:a.options?.delayMs||500,timeout:a.options?.timeout||15e3,maxRetries:a.options?.maxRetries||2,extractionMode:"general",enableUrlNormalization:!0,enablePaginationDiscovery:!1,enableStructuredLogging:!0,correlationId:b.correlationId,onProgress:a=>{this.logger.info("Processing progress",{jobId:b.jobId,completed:a.completed,total:a.total,percentage:a.percentage,errors:a.errors})}}),d=await c.processBatch(a.urls),e={results:await Promise.all(d.results.map(async b=>{if(!b.success||!b.data)return{url:b.url,success:!1,error:b.error,category:b.category,responseTime:b.responseTime,canonicalized:b.canonicalized};try{let c=await this.extractArticleData(b.data.content||b.data.html||"",b.url,a.options||{});return{url:b.url,success:!0,data:c,responseTime:b.responseTime,canonicalized:b.canonicalized}}catch(a){return this.logger.warn("Article extraction failed",{url:b.url,error:a instanceof Error?a.message:"Unknown error"}),{url:b.url,success:!1,error:`Article extraction failed: ${a instanceof Error?a.message:"Unknown error"}`,category:"extraction_error",responseTime:b.responseTime,canonicalized:b.canonicalized}}})),summary:{total:d.stats.totalUrls,successful:d.results.filter(a=>a.success).length,failed:d.results.filter(a=>!a.success).length,averageTime:d.summary.averageResponseTime,errors:d.errors.map(a=>({url:a.url,error:a.error,category:a.category}))},metadata:{jobId:b.jobId,mode:this.id,startTime:new Date(d.stats.startTime).toISOString(),endTime:new Date(d.stats.endTime).toISOString(),duration:d.stats.duration}};return this.logger.info("News articles extraction completed",{jobId:b.jobId,totalUrls:e.summary.total,successfulUrls:e.summary.successful,failedUrls:e.summary.failed,duration:e.metadata.duration}),e}catch(a){throw this.logger.error("News articles extraction failed",{jobId:b.jobId,error:a instanceof Error?a.message:"Unknown error"}),a}}async extractArticleData(a,b,c){let d=new f.JSDOM(a).window.document,e={title:this.extractTitle(d),byline:this.extractByline(d),author:this.extractAuthor(d),publishDate:this.extractPublishDate(d,c.dateFormat),modifiedDate:this.extractModifiedDate(d,c.dateFormat),excerpt:this.extractExcerpt(d),content:c.extractContent?this.extractContent(d,c.maxContentLength):void 0,wordCount:void 0,readingTime:void 0,tags:this.extractTags(d),category:this.extractCategory(d),images:c.extractImages?this.extractImages(d,b):void 0,metadata:{extractedAt:new Date().toISOString(),confidence:0,source:b,language:this.extractLanguage(d)}};return e.content&&(e.wordCount=this.calculateWordCount(e.content),e.readingTime=Math.ceil(e.wordCount/200)),e.metadata.confidence=this.calculateConfidence(e),e}extractTitle(a){for(let b of['h1[class*="title"]','h1[class*="headline"]',".article-title",".entry-title","h1.title","h1.headline","article h1",'[property="og:title"]',"title"]){let c=a.querySelector(b);if(c){let a='[property="og:title"]'===b?c.getAttribute("content"):c.textContent;if(a?.trim())return a.trim()}}}extractByline(a){for(let b of[".byline",".author-byline",".article-byline",'[class*="byline"]',".author-info",".article-meta .author"]){let c=a.querySelector(b);if(c?.textContent?.trim())return c.textContent.trim()}}extractAuthor(a){for(let b of['[rel="author"]',".author",".article-author",'[class*="author"]','[property="article:author"]','[name="author"]']){let c=a.querySelector(b);if(c){let a=c.getAttribute("content")||c.textContent;if(a?.trim())return a.trim()}}}extractPublishDate(a,b="iso"){for(let c of['[property="article:published_time"]','[name="article:published_time"]',"time[datetime]",".publish-date",".article-date",'[class*="publish"]','[class*="date"]']){let d=a.querySelector(c);if(d){let a=d.getAttribute("content")||d.getAttribute("datetime")||d.textContent?.trim();if(a){let c=new Date(a);if(!isNaN(c.getTime()))return this.formatDate(c,b)}}}}extractModifiedDate(a,b="iso"){for(let c of['[property="article:modified_time"]','[name="article:modified_time"]',".modified-date",".updated-date"]){let d=a.querySelector(c);if(d){let a=d.getAttribute("content")||d.textContent?.trim();if(a){let c=new Date(a);if(!isNaN(c.getTime()))return this.formatDate(c,b)}}}}extractExcerpt(a){for(let b of['[property="og:description"]','[name="description"]',".article-excerpt",".excerpt",".summary",".lead"]){let c=a.querySelector(b);if(c){let a=c.getAttribute("content")||c.textContent;if(a?.trim())return a.trim()}}}extractContent(a,b=5e3){for(let c of["article",".article-content",".entry-content",".post-content",".content","main"]){let d=a.querySelector(c);if(d){d.querySelectorAll("script, style").forEach(a=>a.remove());let a=d.textContent?.trim();if(a&&a.length>100)return a.length>b?a.substring(0,b)+"...":a}}}extractTags(a){let b=[],c=a.querySelector('[name="keywords"]');if(c){let a=c.getAttribute("content");a&&b.push(...a.split(",").map(a=>a.trim()))}return a.querySelectorAll('.tags a, .tag, [class*="tag"]').forEach(a=>{let c=a.textContent?.trim();c&&!b.includes(c)&&b.push(c)}),b.filter(a=>a.length>0).slice(0,10)}extractCategory(a){for(let b of[".category",".article-category",'[class*="category"]',".breadcrumb a:last-of-type"]){let c=a.querySelector(b);if(c?.textContent?.trim())return c.textContent.trim()}}extractImages(a,b){let c=[];return a.querySelectorAll("article img, .article-content img, .content img").forEach(a=>{let d=a.getAttribute("src");if(d)try{let e=new URL(d,b).href;c.push({src:e,alt:a.getAttribute("alt")||void 0,caption:this.extractImageCaption(a),width:a.getAttribute("width")?parseInt(a.getAttribute("width")):void 0,height:a.getAttribute("height")?parseInt(a.getAttribute("height")):void 0})}catch{}}),c.slice(0,5)}extractImageCaption(a){let b=a.parentElement;if(b){let a=b.querySelector("figcaption, .caption");if(a?.textContent?.trim())return a.textContent.trim()}return a.getAttribute("title")||void 0}extractLanguage(a){return a.documentElement.getAttribute("lang")||a.querySelector('[property="og:locale"]')?.getAttribute("content")||void 0}calculateWordCount(a){return a.split(/\s+/).filter(a=>a.length>0).length}formatDate(a,b){switch(b){case"timestamp":return a.getTime().toString();case"human":return a.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});default:return a.toISOString()}}calculateConfidence(a){let b=0;return a.title&&(b+=.3),(a.author||a.byline)&&(b+=.2),a.publishDate&&(b+=.2),a.content&&a.content.length>500&&(b+=.2),a.excerpt&&(b+=.1),Math.min(b,1)}async validate(a){let b=[];if(a.urls&&0!==a.urls.length||b.push("At least one URL is required"),a.urls)for(let c=0;c<a.urls.length;c++)try{new URL(a.urls[c])}catch{b.push(`Invalid URL at position ${c+1}: ${a.urls[c]}`)}return a.urls&&a.urls.length>(this.uiHints.maxBatchSize||1e3)&&b.push(`Too many URLs. Maximum allowed: ${this.uiHints.maxBatchSize}`),a.options&&a.options.maxContentLength&&(a.options.maxContentLength<100||a.options.maxContentLength>5e4)&&b.push("Max content length must be between 100 and 50000 characters"),{valid:0===b.length,errors:b.length>0?b:void 0}}constructor(){this.id="news-articles",this.label="News Articles",this.description="Extract article metadata, content, and structured data from news article URLs",this.version="1.0.0",this.inputSchema=k,this.outputSchema=l,this.uiHints={inputType:"urls",supportsBatch:!0,supportsProgress:!0,estimatedTimePerUrl:1500,maxBatchSize:1e3,fileFormats:["txt","csv"],placeholder:"Enter news article URLs (one per line)\nExample: https://news.example.com/article/breaking-news",helpText:"Extracts article titles, bylines, publication dates, content, and metadata from news articles.",examples:["https://www.bbc.com/news/world-12345678","https://www.cnn.com/2024/01/15/politics/news-story/index.html","https://www.reuters.com/world/article-title-2024-01-15/"]},this.logger=(0,h.createLogger)("news-articles-mode")}}d()}catch(a){d(a)}})},4298:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{b:()=>m});var e=c(2971),f=c(995),g=c(5586),h=c(688),i=c(5614),j=a([e,f,i]);[e,f,i]=j.then?(await j)():j;let k=e.z.object({urls:e.z.array(e.z.string().url()).min(1).max(1500),options:e.z.object({concurrency:e.z.number().min(1).max(20).optional().default(3),delayMs:e.z.number().min(0).max(1e4).optional().default(1e3),timeout:e.z.number().min(1e3).max(6e4).optional().default(3e4),maxRetries:e.z.number().min(0).max(5).optional().default(3),enablePaginationDiscovery:e.z.boolean().optional().default(!0),enableUrlNormalization:e.z.boolean().optional().default(!0),extractionDepth:e.z.enum(["basic","detailed"]).optional().default("basic")}).optional().default({})}),l=f.B8.extend({results:e.z.array(e.z.object({url:e.z.string(),success:e.z.boolean(),data:e.z.object({companies:e.z.array(e.z.object({name:e.z.string().optional(),website:e.z.string().optional(),email:e.z.string().optional(),phone:e.z.string().optional(),address:e.z.string().optional(),description:e.z.string().optional(),category:e.z.string().optional(),metadata:e.z.object({extractedAt:e.z.string(),confidence:e.z.number(),source:e.z.string()}).optional()})).optional(),pagination:e.z.object({currentPage:e.z.number().optional(),totalPages:e.z.number().optional(),nextPageUrl:e.z.string().optional(),discoveredUrls:e.z.array(e.z.string()).optional()}).optional()}).optional(),error:e.z.string().optional(),category:e.z.string().optional(),responseTime:e.z.number().optional(),canonicalized:e.z.boolean().optional(),paginationDiscovered:e.z.boolean().optional()}))});class m{async run(a,b){this.logger.info("Starting supplier directory extraction",{jobId:b.jobId,urlCount:a.urls.length,options:a.options});try{let c=new i.Z({concurrency:a.options?.concurrency||3,delayMs:a.options?.delayMs||1e3,timeout:a.options?.timeout||3e4,maxRetries:a.options?.maxRetries||3,extractionMode:"supplier-directory",enableUrlNormalization:a.options?.enableUrlNormalization!==!1,enablePaginationDiscovery:a.options?.enablePaginationDiscovery!==!1,enableStructuredLogging:!0,correlationId:b.correlationId,onProgress:a=>{this.logger.info("Processing progress",{jobId:b.jobId,completed:a.completed,total:a.total,percentage:a.percentage,errors:a.errors})}}),d=await c.processBatch(a.urls),e={results:d.results.map(a=>({url:a.url,success:a.success,data:a.success&&a.data?{companies:Array.isArray(a.data.companies)?a.data.companies:[],pagination:a.data.pagination||void 0}:void 0,error:a.error,category:a.category,responseTime:a.responseTime,canonicalized:a.canonicalized,paginationDiscovered:a.paginationDiscovered})),summary:{total:d.stats.totalUrls,successful:d.stats.successfulUrls,failed:d.stats.failedUrls,averageTime:d.summary.averageResponseTime,errors:d.errors.map(a=>({url:a.url,error:a.error,category:a.category}))},metadata:{jobId:b.jobId,mode:this.id,startTime:new Date(d.stats.startTime).toISOString(),endTime:new Date(d.stats.endTime).toISOString(),duration:d.stats.duration}};return this.logger.info("Supplier directory extraction completed",{jobId:b.jobId,totalUrls:e.summary.total,successfulUrls:e.summary.successful,failedUrls:e.summary.failed,duration:e.metadata.duration}),e}catch(a){throw this.logger.error("Supplier directory extraction failed",{jobId:b.jobId,error:a instanceof Error?a.message:"Unknown error"}),a}}async validate(a){let b=[];if(a.urls&&0!==a.urls.length||b.push("At least one URL is required"),a.urls)for(let c=0;c<a.urls.length;c++)try{new URL(a.urls[c])}catch{b.push(`Invalid URL at position ${c+1}: ${a.urls[c]}`)}return a.urls&&a.urls.length>(this.uiHints.maxBatchSize||500)&&b.push(`Too many URLs. Maximum allowed: ${this.uiHints.maxBatchSize}`),a.options&&(a.options.concurrency&&(a.options.concurrency<1||a.options.concurrency>20)&&b.push("Concurrency must be between 1 and 20"),a.options.delayMs&&(a.options.delayMs<0||a.options.delayMs>1e4)&&b.push("Delay must be between 0 and 10000 milliseconds"),a.options.timeout&&(a.options.timeout<1e3||a.options.timeout>6e4)&&b.push("Timeout must be between 1000 and 60000 milliseconds")),{valid:0===b.length,errors:b.length>0?b:void 0}}async transform(a,b){if(a.results){for(let b of a.results)if(b.success&&b.data?.companies)for(let a of b.data.companies)a.name&&(a.name=a.name.trim()),a.website&&!a.website.startsWith("http")&&(a.website=`https://${a.website}`),a.phone&&(a.phone=a.phone.replace(/[^\d\-\(\)\+\s]/g,"").trim())}return a}constructor(){this.id="supplier-directory",this.label="Supplier Directory",this.description="Extract company listings and contact information from supplier directory pages",this.version="1.0.0",this.inputSchema=k,this.outputSchema=l,this.uiHints={inputType:"urls",supportsBatch:!0,supportsProgress:!0,estimatedTimePerUrl:2e3,maxBatchSize:500,fileFormats:["txt","csv"],placeholder:"Enter supplier directory URLs (one per line)\nExample: https://directory.example.com/suppliers",helpText:"Extracts company listings from supplier directory pages. Supports pagination discovery and URL normalization.",examples:["https://www.d2pbuyersguide.com/filter/all/page/1","https://directory.example.com/suppliers","https://business-directory.com/companies"]},this.logger=(0,g.createLogger)("supplier-directory-mode"),this.extractor=new h.SupplierDirectoryExtractor}}d()}catch(a){d(a)}})},4339:(a,b,c)=>{let d=c(4552)({level:process.env.LOG_LEVEL||"info",redact:{paths:["req.headers.authorization","req.headers.cookie"],remove:!0}});a.exports=function(a){return a?d.child({correlationId:a}):d}},5009:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{T:()=>m});var e=c(2971),f=c(995),g=c(5586),h=c(5791),i=c(5614),j=a([e,f,i]);[e,f,i]=j.then?(await j)():j;let k=e.z.object({urls:e.z.array(e.z.string().url()).min(1).max(1500),options:e.z.object({concurrency:e.z.number().min(1).max(20).optional().default(2),delayMs:e.z.number().min(0).max(1e4).optional().default(2e3),timeout:e.z.number().min(1e3).max(6e4).optional().default(3e4),maxRetries:e.z.number().min(0).max(5).optional().default(3),extractTables:e.z.boolean().optional().default(!0),extractBiography:e.z.boolean().optional().default(!0),extractAchievements:e.z.boolean().optional().default(!0),includePlaceholderData:e.z.boolean().optional().default(!1),sportsSite:e.z.enum(["pro-football-reference","basketball-reference","baseball-reference","hockey-reference","auto"]).optional().default("auto")}).optional().default({})}),l=f.B8.extend({results:e.z.array(e.z.object({url:e.z.string(),success:e.z.boolean(),data:e.z.object({playerName:e.z.string().optional(),position:e.z.string().optional(),team:e.z.string().optional(),statistics:e.z.record(e.z.any()).optional(),biographical:e.z.record(e.z.any()).optional(),achievements:e.z.array(e.z.string()).optional(),rawTables:e.z.array(e.z.string()).optional(),metadata:e.z.object({url:e.z.string(),extractedAt:e.z.string(),site:e.z.string(),confidence:e.z.number()})}).optional(),error:e.z.string().optional(),category:e.z.string().optional(),responseTime:e.z.number().optional(),canonicalized:e.z.boolean().optional()}))});class m{async run(a,b){this.logger.info("Starting sports data extraction",{jobId:b.jobId,urlCount:a.urls.length,options:a.options});try{let c=new i.Z({concurrency:a.options?.concurrency||2,delayMs:a.options?.delayMs||2e3,timeout:a.options?.timeout||3e4,maxRetries:a.options?.maxRetries||3,extractionMode:"sports",enableUrlNormalization:!0,enablePaginationDiscovery:!1,enableStructuredLogging:!0,correlationId:b.correlationId,onProgress:a=>{this.logger.info("Processing progress",{jobId:b.jobId,completed:a.completed,total:a.total,percentage:a.percentage,errors:a.errors})}}),d=await c.processBatch(a.urls),e={results:d.results.map(b=>({url:b.url,success:b.success,data:b.success&&b.data?{playerName:b.data.playerName,position:b.data.position,team:b.data.team,statistics:a.options?.extractTables!==!1?b.data.statistics:void 0,biographical:a.options?.extractBiography!==!1?b.data.biographical:void 0,achievements:a.options?.extractAchievements!==!1?b.data.achievements:void 0,rawTables:a.options?.extractTables!==!1?b.data.rawTables:void 0,metadata:b.data.metadata||{url:b.url,extractedAt:new Date().toISOString(),site:this.extractSiteFromUrl(b.url),confidence:0}}:void 0,error:b.error,category:b.category,responseTime:b.responseTime,canonicalized:b.canonicalized})),summary:{total:d.stats.totalUrls,successful:d.stats.successfulUrls,failed:d.stats.failedUrls,averageTime:d.summary.averageResponseTime,errors:d.errors.map(a=>({url:a.url,error:a.error,category:a.category}))},metadata:{jobId:b.jobId,mode:this.id,startTime:new Date(d.stats.startTime).toISOString(),endTime:new Date(d.stats.endTime).toISOString(),duration:d.stats.duration}};return this.logger.info("Sports data extraction completed",{jobId:b.jobId,totalUrls:e.summary.total,successfulUrls:e.summary.successful,failedUrls:e.summary.failed,duration:e.metadata.duration,playersExtracted:e.results.filter(a=>a.success&&a.data?.playerName).length}),e}catch(a){throw this.logger.error("Sports data extraction failed",{jobId:b.jobId,error:a instanceof Error?a.message:"Unknown error"}),a}}extractSiteFromUrl(a){try{return new URL(a).hostname.replace("www.","")}catch{return"unknown"}}async validate(a){let b=[];if(a.urls&&0!==a.urls.length||b.push("At least one URL is required"),a.urls){let c=["pro-football-reference.com","basketball-reference.com","baseball-reference.com","hockey-reference.com","sports-reference.com"];for(let d=0;d<a.urls.length;d++)try{let b=new URL(a.urls[d]).hostname.replace("www.","");c.includes(b)||this.logger.warn("Unsupported sports domain",{url:a.urls[d],domain:b,supportedDomains:c})}catch{b.push(`Invalid URL at position ${d+1}: ${a.urls[d]}`)}}return a.urls&&a.urls.length>(this.uiHints.maxBatchSize||200)&&b.push(`Too many URLs. Maximum allowed for sports mode: ${this.uiHints.maxBatchSize}`),a.options&&(a.options.concurrency&&(a.options.concurrency<1||a.options.concurrency>5)&&b.push("Concurrency for sports mode must be between 1 and 5 (to respect site limits)"),a.options.delayMs&&a.options.delayMs<1e3&&b.push("Delay for sports mode must be at least 1000ms (to respect site limits)")),{valid:0===b.length,errors:b.length>0?b:void 0}}async transform(a,b){if(a.results)for(let b of a.results)b.success&&b.data&&(b.data.playerName&&(b.data.playerName=this.normalizePlayerName(b.data.playerName)),b.data.position&&(b.data.position=this.normalizePosition(b.data.position)),b.data.team&&(b.data.team=this.normalizeTeamName(b.data.team)),b.data.statistics&&(b.data.statistics=this.normalizeStatistics(b.data.statistics)));return a}normalizePlayerName(a){return a.trim().replace(/\s+/g," ")}normalizePosition(a){return({QB:"Quarterback",RB:"Running Back",FB:"Fullback",WR:"Wide Receiver",TE:"Tight End",OL:"Offensive Line",C:"Center",G:"Guard",T:"Tackle",DL:"Defensive Line",DE:"Defensive End",DT:"Defensive Tackle",LB:"Linebacker",CB:"Cornerback",S:"Safety",FS:"Free Safety",SS:"Strong Safety",K:"Kicker",P:"Punter",LS:"Long Snapper"})[a.trim().toUpperCase()]||a.trim()}normalizeTeamName(a){return a.trim().replace(/\s+/g," ").replace(/\s*\(.*?\)$/,"").trim()}normalizeStatistics(a){let b={};for(let[c,d]of Object.entries(a))if(d&&"object"==typeof d&&!Array.isArray(d)){let a={};for(let[b,c]of Object.entries(d))if(c&&"string"==typeof c){let d=parseFloat(c);a[b]=isNaN(d)?c:d}else a[b]=c;b[c]=a}else b[c]=d;return b}constructor(){this.id="sports",this.label="Sports Statistics",this.description="Extract player statistics, biographical data, and achievements from sports reference sites",this.version="1.0.0",this.inputSchema=k,this.outputSchema=l,this.uiHints={inputType:"urls",supportsBatch:!0,supportsProgress:!0,estimatedTimePerUrl:3e3,maxBatchSize:200,fileFormats:["txt","csv"],placeholder:"Enter sports player URLs (one per line)\nExample: https://www.pro-football-reference.com/players/M/MahoPa00.htm",helpText:"Extracts player statistics, biographical information, and career achievements from Pro Football Reference and other sports sites.",examples:["https://www.pro-football-reference.com/players/M/MahoPa00.htm","https://www.pro-football-reference.com/players/B/BradTo00.htm","https://www.basketball-reference.com/players/j/jamesle01.html","https://www.baseball-reference.com/players/t/troutmi01.shtml"]},this.logger=(0,g.createLogger)("sports-mode"),this.extractor=new h.SportsContentExtractor}}d()}catch(a){d(a)}})},5614:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Z:()=>t});var e=c(2971),f=c(5511),g=c(2325),h=c(2101),i=c(5586),j=c(688),k=c(5791),l=c(8211),m=c(1034),n=a([e,h]);[e,h]=n.then?(await n)():n;let o=e.z.array(e.z.string()).min(1).max(1e4),p=e.z.object({concurrency:e.z.number().int().min(1).max(100).optional(),delayMs:e.z.number().int().min(0).max(6e4).optional(),timeout:e.z.number().int().min(100).max(3e5).optional(),maxRetries:e.z.number().int().min(0).max(10).optional(),errorReportSize:e.z.number().int().min(10).max(1e3).optional(),extractionMode:e.z.enum(["sports","supplier-directory","general"]).optional(),enableUrlNormalization:e.z.boolean().optional(),enablePaginationDiscovery:e.z.boolean().optional(),enableStructuredLogging:e.z.boolean().optional(),onProgress:e.z.function().optional(),onError:e.z.function().optional(),onComplete:e.z.function().optional(),correlationId:e.z.string().uuid().optional()}).strict(),q={NETWORK:"network",TIMEOUT:"timeout",PARSING:"parsing",VALIDATION:"validation",RATE_LIMIT:"rate_limit",SERVER_ERROR:"server_error",CLIENT_ERROR:"client_error",HTTP_404:"http_404",HTTP_403:"http_403",HTTP_401:"http_401",DNS_ERROR:"dns_error",BLOCKED_BY_ROBOTS:"blocked_by_robots",ANTI_BOT_CHALLENGE:"anti_bot_challenge",REDIRECT_LOOP:"redirect_loop",SSL_ERROR:"ssl_error",UNKNOWN:"unknown"},r={IDLE:"idle",VALIDATING:"validating",PROCESSING:"processing",PAUSED:"paused",STOPPED:"stopped",COMPLETED:"completed",ERROR:"error"},s=new Map;class t{constructor(a={}){this.state=r.IDLE,this.urls=[],this.results=[],this.errors=[],this.startTime=0,this.endTime=0,this.processedCount=0,this.successfulCount=0,this.failedCount=0,this.skippedCount=0;let b=p.parse(a);this.batchId=(0,f.randomUUID)(),this.correlationId=b.correlationId||this.batchId,this.logger=(0,i.createLogger)("batch-processor",this.correlationId),this.options={concurrency:b.concurrency||h.A.MAX_CONCURRENCY||5,delayMs:b.delayMs??250,timeout:b.timeout||h.A.DEFAULT_TIMEOUT_MS||3e4,maxRetries:b.maxRetries??h.A.MAX_RETRIES??3,errorReportSize:b.errorReportSize||50,extractionMode:b.extractionMode||"general",enableUrlNormalization:!1!==b.enableUrlNormalization,enablePaginationDiscovery:!1!==b.enablePaginationDiscovery,enableStructuredLogging:!1!==b.enableStructuredLogging,onProgress:b.onProgress||(()=>{}),onError:b.onError||(()=>{}),onComplete:b.onComplete||(()=>{}),correlationId:b.correlationId||this.batchId},this.validateConfiguration(),this.initializeComponents(),s.set(this.batchId,this),this.logger.info("BatchProcessor initialized",{batchId:this.batchId,options:this.options})}validateConfiguration(){let a=[];if((this.options.concurrency<1||this.options.concurrency>100)&&a.push("Concurrency must be between 1 and 100"),(this.options.delayMs<0||this.options.delayMs>6e4)&&a.push("Delay must be between 0 and 60000ms"),(this.options.timeout<100||this.options.timeout>3e5)&&a.push("Timeout must be between 100 and 300000ms"),(this.options.maxRetries<0||this.options.maxRetries>10)&&a.push("Max retries must be between 0 and 10"),a.length>0)throw Error(`Configuration validation failed: ${a.join(", ")}`)}initializeComponents(){switch(this.options.enableStructuredLogging&&(this.structuredLogger=new m.StructuredLogger({jobId:this.batchId,logDirectory:"./logs",enableConsoleLogging:!0,enableFileLogging:!0})),this.options.extractionMode){case"supplier-directory":this.extractor=new j.SupplierDirectoryExtractor;break;case"sports":this.extractor=new k.SportsContentExtractor}this.fetchClient=new l.EnhancedFetchClient({timeout:this.options.timeout,maxRetries:this.options.maxRetries,enableUrlNormalization:this.options.enableUrlNormalization,enablePaginationDiscovery:this.options.enablePaginationDiscovery,structuredLogger:this.structuredLogger})}async processBatch(a){if(this.state!==r.IDLE)throw Error(`Cannot process batch in state: ${this.state}`);try{this.state=r.VALIDATING,this.logger.info("Starting batch validation",{urlCount:a.length});let b=o.parse(a);this.urls=[...b],this.state=r.PROCESSING,this.startTime=Date.now(),this.abortController=new AbortController,this.logger.info("Starting batch processing",{batchId:this.batchId,urlCount:this.urls.length,concurrency:this.options.concurrency,extractionMode:this.options.extractionMode}),await this.processUrlsInBatches(),this.state=r.COMPLETED,this.endTime=Date.now();let c=this.generateResult();return this.logger.info("Batch processing completed",{batchId:this.batchId,stats:c.stats}),this.options.onComplete(c),this.structuredLogger&&await this.structuredLogger.finalize(),c}catch(b){this.state=r.ERROR,this.endTime=Date.now();let a=b instanceof Error?b.message:"Unknown error";throw this.logger.error("Batch processing failed",{batchId:this.batchId,error:a,state:this.state}),b}finally{this.cleanup()}}async processUrlsInBatches(){let a=[];for(let b=0;b<this.urls.length;b+=this.options.concurrency)a.push(this.urls.slice(b,b+this.options.concurrency));for(let b of a){if(this.abortController?.signal.aborted){this.logger.warn("Batch processing aborted");break}await Promise.all(b.map(a=>this.processUrl(a))),this.options.delayMs>0&&await new Promise(a=>setTimeout(a,this.options.delayMs)),this.updateProgress()}}async processUrl(a){let b=Date.now(),c=0,d=null;for(;c<=this.options.maxRetries;)try{if(this.abortController?.signal.aborted)return void this.skippedCount++;this.logger.debug("Processing URL",{url:a,attempt:c});let d=await this.fetchClient.fetch(a,{signal:this.abortController?.signal});if(!d.success)throw Error(d.error||"Fetch failed");let e=null;if(this.extractor&&d.content)try{let b=new g.JSDOM(d.content);e=await this.extractor.extract(b.window.document,a)}catch(b){this.logger.warn("Data extraction failed",{url:a,error:b instanceof Error?b.message:"Unknown error"})}this.results.push({url:a,success:!0,data:e,responseTime:Date.now()-b,canonicalized:d.canonicalized,paginationDiscovered:d.paginationDiscovered}),this.successfulCount++,this.processedCount++,this.logger.debug("URL processed successfully",{url:a,responseTime:Date.now()-b,canonicalized:d.canonicalized});return}catch(b){if(d=b instanceof Error?b:Error("Unknown error"),++c<=this.options.maxRetries){let b=Math.min(1e3*Math.pow(2,c-1),1e4);this.logger.debug("Retrying URL after error",{url:a,attempt:c,error:d.message,backoff:b}),await new Promise(a=>setTimeout(a,b))}}let e=this.categorizeError(d),f={url:a,error:d.message,category:e,timestamp:Date.now(),attempt:c,retryable:this.isRetryableError(d)};this.errors.push(f),this.results.push({url:a,success:!1,error:d.message,category:e,responseTime:Date.now()-b}),this.failedCount++,this.processedCount++,this.options.onError(f),this.logger.warn("URL processing failed",{url:a,error:d.message,category:e,attempts:c})}categorizeError(a){let b=a.message.toLowerCase();return b.includes("timeout")?q.TIMEOUT:b.includes("network")||b.includes("connection")?q.NETWORK:b.includes("404")?q.HTTP_404:b.includes("403")?q.HTTP_403:b.includes("401")?q.HTTP_401:b.includes("429")?q.RATE_LIMIT:b.includes("500")||b.includes("502")||b.includes("503")?q.SERVER_ERROR:b.includes("dns")||b.includes("enotfound")?q.DNS_ERROR:b.includes("robots")?q.BLOCKED_BY_ROBOTS:b.includes("cloudflare")||b.includes("challenge")?q.ANTI_BOT_CHALLENGE:b.includes("redirect")?q.REDIRECT_LOOP:b.includes("ssl")||b.includes("certificate")?q.SSL_ERROR:q.UNKNOWN}isRetryableError(a){let b=a.message.toLowerCase();return!(b.includes("404")||b.includes("403")||b.includes("401")||b.includes("robots")||b.includes("dns"))}updateProgress(){let a={completed:this.processedCount,total:this.urls.length,percentage:Math.round(this.processedCount/this.urls.length*100),errors:this.failedCount,state:this.state};this.options.onProgress(a)}generateResult(){let a=this.endTime-this.startTime,b={};Object.values(q).forEach(a=>{b[a]=0}),this.errors.forEach(a=>{b[a.category]++});let c=this.results.filter(a=>void 0!==a.responseTime).map(a=>a.responseTime),d=c.length>0?c.reduce((a,b)=>a+b,0)/c.length:0,e=this.processedCount>0?this.successfulCount/this.processedCount*100:0;return{batchId:this.batchId,stats:{totalUrls:this.urls.length,processedUrls:this.processedCount,successfulUrls:this.successfulCount,failedUrls:this.failedCount,skippedUrls:this.skippedCount,startTime:this.startTime,endTime:this.endTime,duration:a},results:this.results,errors:this.errors.slice(-this.options.errorReportSize),summary:{errorCategories:b,averageResponseTime:d,successRate:e}}}cleanup(){s.delete(this.batchId),this.abortController=void 0}pause(){this.state===r.PROCESSING&&(this.state=r.PAUSED,this.logger.info("Batch processing paused",{batchId:this.batchId}))}resume(){this.state===r.PAUSED&&(this.state=r.PROCESSING,this.logger.info("Batch processing resumed",{batchId:this.batchId}))}stop(){this.state=r.STOPPED,this.abortController?.abort(),this.logger.info("Batch processing stopped",{batchId:this.batchId})}getState(){return this.state}getProgress(){return{completed:this.processedCount,total:this.urls.length,percentage:this.urls.length>0?Math.round(this.processedCount/this.urls.length*100):0,errors:this.failedCount,state:this.state}}}process.on("SIGINT",()=>{for(let[a,b]of(console.log("Received SIGINT, shutting down gracefully..."),s.entries()))console.log(`Stopping batch processor: ${a}`),b.stop();s.clear(),process.exit(0)}),process.on("SIGTERM",()=>{for(let[a,b]of(console.log("Received SIGTERM, shutting down gracefully..."),s.entries()))console.log(`Stopping batch processor: ${a}`),b.stop();s.clear(),process.exit(0)}),d()}catch(a){d(a)}})},5791:a=>{let b={playerBio:[".player-info",".bio",".profile-header",".player-details",'[class*="player"][class*="info"]','[class*="player"][class*="bio"]',".stats-header",".necro-jersey",".player-summary",".player-header",".bio-info",'[id*="player-info"]'],statisticsTables:[".stats_table",".sortable_stats",'table[class*="stats"]','table[id*="stats"]',".data_grid",".stats-container table",".season-stats",".career-stats",".player-stats","table.sortable","table[data-stat]",".table-responsive table"],careerSummary:[".career-stats",".totals",".career-totals",".career-summary",'[class*="career"][class*="summary"]','[class*="career"][class*="total"]',".summary-stats",".aggregate-stats",".lifetime-stats"],biographicalData:[".question",".faq",".bio-section",".personal-info",'[class*="question"]','[class*="faq"]',".player-facts",".vital-stats",".biographical",".profile-data"],achievements:[".awards",".honors",".achievements",".accolades",'[class*="award"]','[class*="honor"]','[class*="achievement"]',".pro-bowl",".all-pro",".hall-of-fame",".records"]},c={"pro-football-reference.com":{playerPagePattern:"/players/",primaryContentSelector:"#content",statsTablesSelector:".stats_table",bioSelector:".necro-jersey, .player-info",excludeSelectors:[".advertisement",".social-media","#header","#footer"],dataPatterns:{seasonStats:/^\d{4}.*stats/i,careerTotals:/career|total/i,biographical:/born|height|weight|college/i,playerName:/h1[itemprop="name"]|h1 span/,position:/.necro-jersey strong/}},"basketball-reference.com":{playerPagePattern:"/players/",primaryContentSelector:"#content",statsTablesSelector:".stats_table",bioSelector:".necro-jersey, .player-info",excludeSelectors:[".advertisement",".social-media"]},"baseball-reference.com":{playerPagePattern:"/players/",primaryContentSelector:"#content",statsTablesSelector:".stats_table",bioSelector:".necro-jersey, .player-info",excludeSelectors:[".advertisement",".social-media"]},"hockey-reference.com":{playerPagePattern:"/players/",primaryContentSelector:"#content",statsTablesSelector:".stats_table",bioSelector:".necro-jersey, .player-info",excludeSelectors:[".advertisement",".social-media"]}},d={general:["stats","statistics","season","career","games","player","team","league","championship","playoff","record","performance","draft"],football:["yards","touchdown","sack","interception","fumble","quarterback","running back","wide receiver","defensive","offensive","nfl","passing","rushing","receiving","tackles","completion"],basketball:["points","rebounds","assists","steals","blocks","field goal","three pointer","free throw","minutes","nba","shooting"],baseball:["batting average","home runs","rbi","era","strikeouts","walks","hits","runs","stolen bases","mlb","pitcher","batter"],hockey:["goals","assists","points","plus minus","penalty minutes","shots","saves","nhl","goalie","forward","defenseman"]};class e{constructor(){this.debug=!0}extractSportsContent(a,b=""){let c=this.getSiteConfig(b),d=this.performMultiPhaseExtraction(a,c);return{content:d.content,structuredData:d.structuredData,method:d.method,score:d.score,debug:d.debug,sportsValidation:this.validateSportsContent(d.content)}}getSiteConfig(a){try{let b=new URL(a).hostname.toLowerCase();for(let[a,d]of Object.entries(c))if(b.includes(a))return{...d,domain:a}}catch(a){}return c["pro-football-reference.com"]}performMultiPhaseExtraction(a,b){let c=a.cloneNode(!0);try{this.cleanDocumentForSports(c,b);let a=this.extractStructuredSportsData(c,b),d=this.performSportsContentDetection(c,b),e=this.scoreSportsContent(d,a),f=this.selectBestSportsContent(e);return{content:this.formatSportsContent(f,a),structuredData:a,method:f?.source||"fallback",score:f?.score||0,debug:{candidatesFound:d.length,structuredDataExtracted:Object.keys(a).length,selectedMethod:f?.source,siteConfig:b.domain}}}finally{this.cleanupDOMClone(c)}}cleanupDOMClone(a){try{for(;a.firstChild;)a.removeChild(a.firstChild);void 0!==a.textContent&&(a.textContent=""),"undefined"!=typeof global&&global.gc&&global.gc()}catch(a){this.debug&&console.warn("DOM cleanup warning:",a.message)}}cleanDocumentForSports(a,b){["script","style","noscript","iframe","object","embed",'nav:not([class*="content"]):not([id*="content"])','footer:not([class*="content"]):not([id*="content"])','header:not([class*="content"]):not([id*="content"])','aside:not([class*="content"]):not([class*="stats"])','[class*="advertisement"]','[class*="ads"]','[id*="ads"]','[class*="social"]:not([class*="content"])','[class*="share"]:not([class*="content"])',...b.excludeSelectors].forEach(b=>{try{a.querySelectorAll(b).forEach(a=>a.remove())}catch(a){}})}extractStructuredSportsData(a,b){let c={player:{},statistics:{career:{},seasons:[],playoffs:{}},achievements:[],transactions:[]};try{c.player=this.extractPlayerBiography(a,b);let d=this.extractStatisticalTables(a,b);c.statistics={...c.statistics,...d},c.achievements=this.extractAchievements(a);let e=this.extractFAQData(a);return c.player={...c.player,...e},c}catch(a){return this.debug&&console.warn("Error in structured data extraction:",a.message),c}}extractPlayerBiography(a,c){let d={};for(let b of['h1[itemprop="name"]',"h1 span","h1",".player-name"]){let c=a.querySelector(b);if(c&&c.textContent.trim()){d.name=c.textContent.trim();break}}let e=a.querySelector(".necro-jersey, .player-position");if(e){let a=e.textContent.match(/([A-Z]{1,3})\s*(?:#(\d+))?/);a&&(d.position=a[1],a[2]&&(d.jerseyNumber=a[2]))}for(let c of b.playerBio.concat(b.biographicalData))try{a.querySelectorAll(c).forEach(a=>{let b=a.textContent,c=b.match(/(?:Height|Ht):\s*(\d+'\s*\d+"?)/i);c&&(d.height=c[1]);let e=b.match(/(?:Weight|Wt):\s*(\d+)\s*lbs?/i);e&&(d.weight=`${e[1]} lbs`);let f=b.match(/Born:\s*([^,]+),?\s*(.+)/i);f&&(d.birthDate=f[1].trim(),d.birthPlace=f[2].trim());let g=b.match(/College:\s*([^\n]+)/i);g&&(d.college=g[1].trim());let h=b.match(/Draft:\s*(\d{4}).*?(\w+).*?(\d+).*?(\d+)/i);h&&(d.draft={year:parseInt(h[1]),team:h[2],round:parseInt(h[3]),pick:parseInt(h[4])})})}catch(a){}return d}extractStatisticalTables(a,c){let d={career:{},seasons:[],playoffs:{}},e=b.statisticsTables,f=[];return e.forEach(b=>{try{let c=Array.from(a.querySelectorAll(b));f.push(...c.map(a=>({element:a,selector:b})))}catch(a){}}),f.forEach(({element:a,selector:b})=>{try{let b=this.parseStatisticalTable(a);if(b&&b.rows.length>0)switch(this.classifyStatisticalTable(b,a)){case"season":d.seasons.push(...b.rows);break;case"career":d.career=b.rows[0]||{};break;case"playoffs":d.playoffs=b.rows[0]||{}}}catch(a){this.debug&&console.log("Error parsing table:",a.message)}}),d}parseStatisticalTable(a){let b=[],c=[],d=a.querySelector("thead tr, tr:first-child");return d&&d.querySelectorAll("th, td").forEach(a=>{b.push(a.textContent.trim())}),a.querySelectorAll("tbody tr, tr:not(:first-child)").forEach(a=>{let d=a.querySelectorAll("td, th");if(0===d.length)return;let e={};d.forEach((a,c)=>{let d=b[c]||`column_${c}`,f=a.textContent.trim();if(f&&!isNaN(f)&&""!==f){let a=parseFloat(f);isNaN(a)||(f=a)}e[d]=f}),Object.keys(e).length>0&&c.push(e)}),{headers:b,rows:c}}classifyStatisticalTable(a,b){let c=b.textContent.toLowerCase(),d=b.id?.toLowerCase()||"",e=b.className?.toLowerCase()||"";return c.includes("career")||c.includes("total")||d.includes("career")||e.includes("career")||d.includes("total")||e.includes("total")?"career":c.includes("playoff")||c.includes("postseason")||d.includes("playoff")||e.includes("playoff")?"playoffs":a.headers.some(a=>/year|season|\d{4}/i.test(a))?"season":"general"}extractAchievements(a){let c=[];return b.achievements.forEach(b=>{try{a.querySelectorAll(b).forEach(a=>{let b=a.textContent.trim();if(b&&b.length>5){let a=b.split(/[,;]|\n/).map(a=>a.trim()).filter(a=>a.length>3);c.push(...a)}})}catch(a){}}),[...new Set(c)]}extractFAQData(a){let c={};return b.biographicalData.forEach(b=>{try{a.querySelectorAll(b).forEach(a=>{let b=a.textContent.match(/([^?]+\?)\s*([^?]+?)(?=\s*[^?]*\?|$)/g);b&&b.forEach(a=>{let[b,d]=a.split("?").map(a=>a.trim());b&&d&&(c[b]=d)})})}catch(a){}}),c}performSportsContentDetection(a,c){let d=[],e=[c.primaryContentSelector,"main","article",'[role="main"]','[role="article"]',".player-page",".stats-page",".player-content"];d.push(...this.findContentBySelectors(a,e,"sports-semantic"));let f=[...b.playerBio,...b.statisticsTables,...b.careerSummary,...b.biographicalData];return d.push(...this.findContentBySelectors(a,f,"sports-specific")),d.push(...this.findContentBySelectors(a,['[class*="content"]','[class*="article"]','[class*="story"]','[class*="post"]','[id*="content"]','[id*="article"]','[id*="story"]','[id*="post"]',".main-content",".primary-content",".page-content",".site-content"],"general-content")),d.push(...Array.from(a.querySelectorAll("div, section, article")).filter(a=>a.innerText&&a.innerText.trim().length>100).map(a=>({element:a,source:"text-container"}))),d}findContentBySelectors(a,b,c){let d=[];for(let e of b)try{let b=Array.from(a.querySelectorAll(e));d.push(...b.map(a=>({element:a,source:c})))}catch(a){}return d}scoreSportsContent(a,b){return a.filter(a=>a.element&&a.element.innerText).map(a=>({...a,score:this.calculateSportsContentScore(a.element,a.source,b),text:a.element.innerText.trim()})).filter(a=>a.score>0).sort((a,b)=>b.score-a.score)}calculateSportsContentScore(a,b,c){if(!a||!a.innerText)return 0;let d=a.innerText.trim();if(d.length<50)return 0;let e=this.calculateBaseContentScore(a),f;f=0+(({"sports-semantic":200,"sports-specific":150,"general-content":50,"text-container":10})[b]||0);let g=this.calculateSportsKeywordScore(d);f+=g;let h=a.querySelectorAll("table").length;return f+=Math.min(100*h,500),c.player.name&&d.includes(c.player.name)&&(f+=100),[/\d+\s*(yards|points|touchdowns|sacks|tackles|assists|rebounds)/gi,/\d{4}\s*season/gi,/(career|season|playoff)\s*stats/gi].forEach(a=>{let b=(d.match(a)||[]).length;f+=Math.min(20*b,200)}),e+f}calculateSportsKeywordScore(a){let b=a.toLowerCase(),c=0;return Object.values(d).forEach(a=>{a.forEach(a=>{let d=RegExp(`\\b${a}\\b`,"gi"),e=(b.match(d)||[]).length;c+=5*e})}),Math.min(c,300)}calculateBaseContentScore(a){let b,c=a.innerText.trim(),d=c.length,e=c.split(/\s+/).length,f=a.querySelectorAll("a").length,g=a.querySelectorAll("p").length,h=a.querySelectorAll("h1, h2, h3, h4, h5, h6").length,i=a.querySelectorAll("ul, ol").length;b=0+.5*d+Math.min(2*e,1e3);let j=f/(e+1);return Math.max(0,0+30*g+80*h+20*i+b-(j>.1?(j-.1)*500:0))}selectBestSportsContent(a){if(0===a.length)return null;for(let b of a)if(b.text.length>=200&&this.validateSportsContentQuality(b.element))return b;return a.find(a=>a.text.length>=100)||a[0]}validateSportsContentQuality(a){if(!a||!a.innerText)return!1;let b=a.innerText.trim();if(b.split(/\s+/).length<20)return!1;let c=this.calculateSportsKeywordScore(b)>0,d=/\d/.test(b),e=/\d+\s*(yards|points|games|season)/i.test(b);return c&&(d||e)}formatSportsContent(a,b){if(!a)return"";let c=a.text;if(b.player.name){let a=`
=== PLAYER INFORMATION ===
`;b.player.name&&(a+=`Name: ${b.player.name}
`),b.player.position&&(a+=`Position: ${b.player.position}
`),b.player.height&&(a+=`Height: ${b.player.height}
`),b.player.weight&&(a+=`Weight: ${b.player.weight}
`),b.player.college&&(a+=`College: ${b.player.college}
`),b.achievements.length>0&&(a+=`
Achievements: ${b.achievements.slice(0,5).join(", ")}
`),a+=`
=== CONTENT ===
`,c=a+c}return this.cleanFinalContent(c)}cleanFinalContent(a){return a?a.replace(/[\r\n\t]+/g,"\n").replace(/[ \u00A0]+/g," ").replace(/\n\s*\n\s*\n+/g,"\n\n").trim():""}validateSportsContent(a){if(!a)return{isValid:!1,score:0,reasons:["No content"]};let b={},c=0;Object.entries({hasPlayerName:a=>/^[A-Z][a-z]+\s+[A-Z][a-z]+/.test(a),hasStats:a=>/\d+\s*(yards|points|touchdowns|sacks|tackles|assists|rebounds)/i.test(a),hasSeasons:a=>/20\d{2}|19\d{2}/.test(a),hasBiography:a=>/born|height|weight|college/i.test(a),hasSportsKeywords:a=>this.calculateSportsKeywordScore(a)>20,hasNumericalData:a=>/\d+/.test(a)}).forEach(([d,e])=>{let f=e(a);b[d]=f,f&&(c+=1)});let d=c>=3,e=Object.entries(b).filter(([a,b])=>!b).map(([a,b])=>a);return{isValid:d,score:c,results:b,reasons:e}}}a.exports={SportsContentExtractor:e,SPORTS_SELECTORS:b,SITE_CONFIGS:c}},6685:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{$:()=>i});var e=c(5586),f=c(995),g=a([f]);f=(g.then?(await g)():g)[0];class h{constructor(){this.modes=new Map,this.logger=(0,e.createLogger)("mode-registry"),this.logger.info("Mode registry initialized")}register(a){if(!(0,f.Cw)(a))throw new f.eC("Invalid mode contract","INVALID_CONTRACT",{mode:a});this.modes.has(a.id)&&this.logger.warn("Mode already registered, updating",{modeId:a.id});let b={mode:a,registered:new Date,usageCount:0,enabled:!0};this.modes.set(a.id,b),this.logger.info("Mode registered",{modeId:a.id,label:a.label,version:a.version})}unregister(a){let b=this.modes.delete(a);return b&&this.logger.info("Mode unregistered",{modeId:a}),b}getMode(a){let b=this.modes.get(a);if(!b)throw new f.lo(a);if(!b.enabled)throw new f.eC(`Mode is disabled: ${a}`,"MODE_DISABLED",{modeId:a});return b.usageCount++,b.lastUsed=new Date,b.mode}listModes(){return Array.from(this.modes.values()).map(a=>({id:a.mode.id,label:a.mode.label,description:a.mode.description,version:a.mode.version,enabled:a.enabled,usageCount:a.usageCount,lastUsed:a.lastUsed}))}getEnabledModes(){return Array.from(this.modes.values()).filter(a=>a.enabled).map(a=>a.mode)}hasMode(a){return this.modes.has(a)}setModeEnabled(a,b){let c=this.modes.get(a);if(!c)throw new f.lo(a);c.enabled=b,this.logger.info("Mode status changed",{modeId:a,enabled:b})}getStats(){let a=Array.from(this.modes.values()),b=a.reduce((a,b)=>a+b.usageCount,0),c=a.reduce((a,b)=>b.usageCount>(a?.usageCount||0)?b:a,null);return{totalModes:a.length,enabledModes:a.filter(a=>a.enabled).length,disabledModes:a.filter(a=>!a.enabled).length,totalUsage:b,mostUsedMode:c?.mode.id}}async validateInput(a,b){let c=this.modes.get(a);if(!c)throw new f.lo(a);if(!c.enabled)throw new f.eC(`Mode is disabled: ${a}`,"MODE_DISABLED",{modeId:a});let d=c.mode;try{if(d.inputSchema.parse(b),d.validate)return await d.validate(b);return{valid:!0}}catch(a){if(a instanceof Error)return{valid:!1,errors:[a.message]};return{valid:!1,errors:["Unknown validation error"]}}}async execute(a,b,c){let d=this.modes.get(a);if(!d)throw new f.lo(a);if(!d.enabled)throw new f.eC(`Mode is disabled: ${a}`,"MODE_DISABLED",{modeId:a});let e=d.mode;this.logger.info("Executing mode",{modeId:a,jobId:c.jobId,correlationId:c.correlationId});try{let g=await this.validateInput(a,b);if(!g.valid)throw new f.eC("Input validation failed","VALIDATION_ERROR",{errors:g.errors});let h=Date.now(),i=await e.run(b,c),j=Date.now()-h;e.outputSchema.parse(i);let k=e.transform?await e.transform(i,b):i;return d.usageCount++,d.lastUsed=new Date,this.logger.info("Mode execution completed",{modeId:a,jobId:c.jobId,duration:j}),k}catch(b){throw this.logger.error("Mode execution failed",{modeId:a,jobId:c.jobId,error:b instanceof Error?b.message:"Unknown error"}),b}}clear(){this.modes.clear(),this.logger.info("Registry cleared")}}let i=new h;d()}catch(a){d(a)}})},6980:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{lM:()=>k});var e=c(6685),f=c(4298),g=c(2803),h=c(5009),i=c(5586),j=a([e,f,g,h]);[e,f,g,h]=j.then?(await j)():j;let l=(0,i.createLogger)("mode-initialization");function k(){try{l.info("Initializing modes...");let a=[new f.b,new g.a,new h.T],b=0;for(let c of a)try{e.$.register(c),b++,l.info("Mode registered successfully",{modeId:c.id,label:c.label,version:c.version})}catch(a){l.error("Failed to register mode",{modeId:c.id,error:a instanceof Error?a.message:"Unknown error"})}l.info("Mode initialization completed",{totalModes:a.length,registeredModes:b,failedModes:a.length-b})}catch(a){throw l.error("Mode initialization failed",{error:a instanceof Error?a.message:"Unknown error"}),a}}d()}catch(a){d(a)}})},8211:(a,b,c)=>{let{URL:d}=c(9551),e=c(4339),{UrlCanonicalizer:f}=c(8370),{PaginationDiscovery:g}=c(2232),{JSDOM:h}=c(2325),{renderSpaPage:i}=c(1312);class j{constructor(a={}){this.logger=e("enhanced-fetch-client"),this.options={timeout:a.timeout||3e4,maxRedirects:a.maxRedirects||5,respectRobots:!1!==a.respectRobots,enableCanonicalization:!1!==a.enableCanonicalization,enablePaginationDiscovery:!1!==a.enablePaginationDiscovery,consecutiveErrorThreshold:a.consecutiveErrorThreshold||3,rateLimitPerSecond:a.rateLimitPerSecond||2,jitterMs:a.jitterMs||500,...a},this.canonicalizer=new f({maxVariants:4,preflightTimeout:5e3,backoffDelays:[500,1e3,2e3]}),this.paginationDiscovery=new g({paginationMode:"auto",maxConsecutive404s:3,maxPagesToDiscover:50}),this.robotsCache=new Map,this.robotsCacheMaxAge=36e5,this.cookieJar=new Map,this.sessionHeaders=new Map,this.hostLastRequest=new Map,this.consecutiveErrors=new Map,this.defaultHeaders={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 EdgeScraperPro/2.0",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Pragma:"no-cache","Sec-Ch-Ua":'"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',"Sec-Ch-Ua-Mobile":"?0","Sec-Ch-Ua-Platform":'"Windows"',"Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1"}}async checkRobotsTxt(a){if(!this.options.respectRobots)return!0;try{let b=new d(a),c=`${b.protocol}//${b.host}/robots.txt`,e=this.robotsCache.get(c);if(e&&Date.now()-e.timestamp<this.robotsCacheMaxAge)return this.isPathAllowed(e.content,b.pathname,this.defaultHeaders["User-Agent"]);this.logger.debug({robotsUrl:c},"Fetching robots.txt");let f=await this.baseFetch(c,{method:"GET",timeout:5e3,headers:{"User-Agent":this.defaultHeaders["User-Agent"]}}),g="";return f.ok&&(g=await f.text()),this.robotsCache.set(c,{content:g,timestamp:Date.now()}),this.isPathAllowed(g,b.pathname,this.defaultHeaders["User-Agent"])}catch(b){return this.logger.warn({url:a,error:b.message},"Failed to check robots.txt, allowing by default"),!0}}isPathAllowed(a,b,c){if(!a)return!0;let d=a.split("\n").map(a=>a.trim()),e=!1;for(let a of d)if(!a.startsWith("#")&&a){if(a.toLowerCase().startsWith("user-agent:")){let b=a.substring(11).trim();e="*"===b||c.includes(b);continue}if(e&&a.toLowerCase().startsWith("disallow:")){let c=a.substring(9).trim();if(c&&b.startsWith(c))return!1}}return!0}async applyRateLimit(a){let b=Date.now(),c=this.hostLastRequest.get(a)||0,d=1e3/this.options.rateLimitPerSecond,e=b-c;if(e<d){let b=d-e+Math.random()*this.options.jitterMs;this.logger.debug({hostname:a,delay:b},"Applying rate limit delay"),await new Promise(a=>setTimeout(a,b))}this.hostLastRequest.set(a,Date.now())}shouldContinueRequests(a){return(this.consecutiveErrors.get(a)||0)<this.options.consecutiveErrorThreshold}recordRequestResult(a,b){if(b)this.consecutiveErrors.delete(a);else{let b=this.consecutiveErrors.get(a)||0;this.consecutiveErrors.set(a,b+1)}}async baseFetch(a,b={}){let c=new AbortController,d=setTimeout(()=>c.abort(),b.timeout||this.options.timeout);try{let e=await fetch(a,{...b,signal:c.signal,headers:{...this.defaultHeaders,...b.headers}});return clearTimeout(d),e}catch(a){if(clearTimeout(d),"AbortError"===a.name){let a=Error(`Request timeout after ${b.timeout||this.options.timeout}ms`);throw a.code="ETIMEDOUT",a}throw a}}async enhancedFetch(a,b={}){let c,e=Date.now(),f=new d(a),g=f.hostname;if(!this.shouldContinueRequests(g)){let a=Error(`Skipping request due to ${this.options.consecutiveErrorThreshold} consecutive errors`);throw a.code="CONSECUTIVE_ERRORS",a}if(await this.applyRateLimit(g),!await this.checkRobotsTxt(a)){let a=Error("Request blocked by robots.txt");throw a.code="BLOCKED_BY_ROBOTS",a.status=403,a}let j=null,k=a;try{let l={...b.headers,Referer:`${f.protocol}//${f.host}/`};if(this.logger.debug({url:a},"Attempting original URL"),(c=await this.baseFetch(a,{...b,headers:l})).ok)return this.recordRequestResult(g,!0),{response:c,originalUrl:a,resolvedUrl:k,canonicalizationResult:j,robotsAllowed:!0,responseTime:Date.now()-e,fromCache:!1};if(404===c.status&&this.options.enableCanonicalization&&(this.logger.info({url:a,status:c.status},"Original URL failed, attempting canonicalization"),(j=await this.canonicalizer.canonicalizeUrl(a,(a,c)=>this.baseFetch(a,{...b,...c,headers:{...l,Referer:`${new d(a).protocol}//${new d(a).host}/`}}))).success&&(k=j.canonicalUrl,c=await this.baseFetch(k,{...b,headers:{...l,Referer:`${new d(k).protocol}//${new d(k).host}/`}}),this.logger.info({originalUrl:a,resolvedUrl:k,attempts:j.attempts.length},"URL canonicalization successful"))),404===c.status){let b=new d(k),f=b.hostname.includes("d2pbuyersguide.com"),l=b.pathname.startsWith("/manufacturer/");if(f&&l){this.logger.info({url:k},"Attempting headless browser render");try{let b=await i(k),d=new h(b);return c=new Response(b,{status:200,headers:{"Content-Type":"text/html"}}),this.recordRequestResult(g,!0),{response:c,dom:d.window.document,originalUrl:a,resolvedUrl:k,canonicalizationResult:j,robotsAllowed:!0,responseTime:Date.now()-e,fromCache:!1,renderedViaBrowser:!0}}catch(a){this.logger.error({url:k,error:a.message},"Headless browser render failed")}}}return this.recordRequestResult(g,c.ok),{response:c,originalUrl:a,resolvedUrl:k,canonicalizationResult:j,robotsAllowed:!0,responseTime:Date.now()-e,fromCache:!1}}catch(b){throw this.recordRequestResult(g,!1),b.originalUrl=a,b.resolvedUrl=k,b.canonicalizationResult=j,b.responseTime=Date.now()-e,b}}async batchFetchWithDiscovery(a,b={}){let c={originalUrls:a,responses:[],discoveredUrls:[],paginationResults:[],summary:{total:a.length,successful:0,failed:0,canonicalized:0,robotsBlocked:0,paginationDiscovered:0}};for(let d of a)try{this.logger.info({url:d},"Processing URL");let a=await this.enhancedFetch(d,b);if(c.responses.push({url:d,success:!0,...a}),c.summary.successful++,a.canonicalizationResult?.success&&c.summary.canonicalized++,this.options.enablePaginationDiscovery&&a.response.ok)try{await a.response.text();let b=await this.paginationDiscovery.discoverPagination(a.resolvedUrl,(a,b)=>this.baseFetch(a,b));b.success&&b.validUrls.length>1&&(c.discoveredUrls.push(...b.validUrls),c.paginationResults.push(b),c.summary.paginationDiscovered++,this.logger.info({url:a.resolvedUrl,discoveredUrls:b.validUrls.length,mode:b.mode},"Pagination discovery successful"))}catch(a){this.logger.warn({url:d,error:a.message},"Pagination discovery failed")}}catch(a){c.responses.push({url:d,success:!1,error:a.message,errorCode:a.code,status:a.status,originalUrl:a.originalUrl,resolvedUrl:a.resolvedUrl,canonicalizationResult:a.canonicalizationResult,responseTime:a.responseTime}),c.summary.failed++,"BLOCKED_BY_ROBOTS"===a.code&&c.summary.robotsBlocked++}return this.logger.info(c.summary,"Batch fetch completed"),c}getStats(){return{robotsCacheSize:this.robotsCache.size,consecutiveErrors:Object.fromEntries(this.consecutiveErrors),canonicalizer:this.canonicalizer.getStats(),paginationDiscovery:this.paginationDiscovery.getStats()}}clearCaches(){this.robotsCache.clear(),this.consecutiveErrors.clear(),this.canonicalizer.clearCache(),this.paginationDiscovery.clearCache(),this.logger.debug("Cleared all caches")}}a.exports={EnhancedFetchClient:j}},8370:(a,b,c)=>{let{URL:d}=c(9551),e=c(4339);class f{constructor(a={}){this.logger=e("url-canonicalizer"),this.options={maxVariants:a.maxVariants||4,preflightTimeout:a.preflightTimeout||5e3,backoffDelays:a.backoffDelays||[500,1e3,2e3],followRedirects:!1!==a.followRedirects,maxRedirects:a.maxRedirects||5,...a},this.canonicalCache=new Map,this.cacheMaxAge=18e5,this.lastCleanup=Date.now(),this.cleanupInterval=3e5}generateUrlVariants(a){try{let{protocol:b,hostname:c,pathname:e,search:f,hash:g}=new d(a),h="/"===e?e:e.replace(/\/$/,""),i="/"===h?"/":h+"/",j=["http:"===b?`https://${c}${h}${f}${g}`:null,"http:"!==b||c.startsWith("www.")?null:`https://www.${c}${h}${f}${g}`,"https:"!==b||c.startsWith("www.")?null:`https://www.${c}${h}${f}${g}`,"http:"===b?`https://${c}${i}${f}${g}`:null,"http:"!==b||c.startsWith("www.")?null:`https://www.${c}${i}${f}${g}`,c.startsWith("www.")?`${b}//${c.substring(4)}${h}${f}${g}`:null,"http:"===b&&c.startsWith("www.")?`https://${c.substring(4)}${h}${f}${g}`:null];return[...new Set(j.filter(Boolean))].filter(b=>b!==a)}catch(b){return this.logger.warn({originalUrl:a,error:b.message},"Failed to parse URL for variants"),[]}}async preflightCheck(a,b){let c=Date.now(),e=[];try{let f,g="HEAD";try{f=await b(a,{method:"HEAD",timeout:this.options.preflightTimeout,redirect:"manual"})}catch(c){this.logger.debug({url:a,headError:c.message},"HEAD failed, trying GET"),g="GET",f=await b(a,{method:"GET",timeout:this.options.preflightTimeout,redirect:"manual"})}let h=f,i=a,j=0;for(;h.status>=300&&h.status<400&&h.headers.get("location")&&j<this.options.maxRedirects;){let a=h.headers.get("location"),c=new d(a,i).toString();e.push({from:i,to:c,status:h.status}),i=c,j++,h=await b(c,{method:g,timeout:this.options.preflightTimeout,redirect:"manual"})}let k=Date.now()-c;return{success:h.status>=200&&h.status<400,status:h.status,finalUrl:i,redirectChain:e,responseTime:k,headers:{"cache-control":h.headers.get("cache-control"),server:h.headers.get("server"),"content-type":h.headers.get("content-type")},method:g}}catch(b){let a=Date.now()-c;return{success:!1,error:b.message,errorCode:b.code,responseTime:a,redirectChain:e}}}async canonicalizeUrl(a,b){let c=this.canonicalCache.get(a);if(c&&Date.now()-c.timestamp<this.cacheMaxAge)return this.logger.debug({originalUrl:a,canonicalUrl:c.result.canonicalUrl},"Using cached canonicalization"),c.result;Date.now()-this.lastCleanup>this.cleanupInterval&&this.cleanupCache();let d=Date.now(),e={originalUrl:a,canonicalUrl:null,success:!1,attempts:[],totalResponseTime:0,redirectChain:[],error:null};this.logger.info({originalUrl:a},"Starting URL canonicalization");let f=this.generateUrlVariants(a);if(0===f.length)return e.error="No viable URL variants to try",this.logger.warn({originalUrl:a},e.error),e;this.logger.debug({originalUrl:a,variants:f},`Trying ${f.length} URL variants`);for(let c=0;c<f.length&&c<this.options.maxVariants;c++){let g=f[c];if(c>0&&this.options.backoffDelays[Math.min(c-1,this.options.backoffDelays.length-1)]){let a=this.options.backoffDelays[Math.min(c-1,this.options.backoffDelays.length-1)];this.logger.debug({variant:g,delay:a},"Applying backoff delay"),await new Promise(b=>setTimeout(b,a))}let h=await this.preflightCheck(g,b);if(e.attempts.push({url:g,...h}),e.totalResponseTime+=h.responseTime||0,h.success)return e.success=!0,e.canonicalUrl=h.finalUrl||g,e.redirectChain=h.redirectChain||[],this.logger.info({originalUrl:a,canonicalUrl:e.canonicalUrl,attempts:c+1,totalTime:Date.now()-d},"URL canonicalization successful"),this.canonicalCache.set(a,{result:{...e},timestamp:Date.now()}),e;this.logger.debug({variant:g,status:h.status,error:h.error},"Variant attempt failed")}return e.error=`All ${e.attempts.length} canonicalization attempts failed`,e.totalResponseTime=Date.now()-d,this.logger.warn({originalUrl:a,attempts:e.attempts.length,totalTime:e.totalResponseTime},e.error),e}cleanupCache(){let a=Date.now(),b=0;for(let[c,d]of this.canonicalCache.entries())a-d.timestamp>this.cacheMaxAge&&(this.canonicalCache.delete(c),b++);this.lastCleanup=a,b>0&&this.logger.debug({cleaned:b,remaining:this.canonicalCache.size},"Cleaned up expired cache entries")}getStats(){return{cacheSize:this.canonicalCache.size,cacheMaxAge:this.cacheMaxAge,lastCleanup:this.lastCleanup}}clearCache(){this.canonicalCache.clear(),this.logger.debug("Cleared canonicalization cache")}}a.exports={UrlCanonicalizer:f}}};