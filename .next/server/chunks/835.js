"use strict";exports.id=835,exports.ids=[835],exports.modules={318:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.defaultLogger=b.Logger=void 0,b.createLogger=function(a,b){return new e(b)};let d=function(a){return a&&a.__esModule?a:{default:a}}(c(4552));class e{constructor(a={level:"info",format:"json"}){this.config=a,this.pino=(0,d.default)({level:a.level,formatters:{level:a=>({level:a})},timestamp:()=>`,"timestamp":"${new Date().toISOString()}"`})}debug(a,b){this.pino.debug(this.formatContext(b),a)}info(a,b){this.pino.info(this.formatContext(b),a)}warn(a,b){this.pino.warn(this.formatContext(b),a)}error(a,b){this.pino.error(this.formatContext(b),a)}taskStart(a,b){this.info("Task started",{...b,taskName:a,event:"task_start"})}taskComplete(a,b){this.info("Task completed",{...b,taskName:a,event:"task_complete"})}taskError(a,b,c){this.error("Task failed",{...c,taskName:a,error:b.message,stack:b.stack,event:"task_error"})}httpRequest(a,b,c){this.info("HTTP request",{...c,method:a,url:b,event:"http_request"})}httpResponse(a,b,c,d,e){this.info("HTTP response",{...e,method:a,url:b,status:c,duration_ms:d,event:"http_response"})}rateLimitHit(a){this.warn("Rate limit hit",{...a,rateLimitHit:!0,event:"rate_limit_hit"})}retryAttempt(a,b,c){this.warn("Retry attempt",{...c,retries:a,error:b.message,event:"retry_attempt"})}formatContext(a){if(!a)return{};let b={...a};return b.timestamp||(b.timestamp=new Date().toISOString()),b}}b.Logger=e,b.defaultLogger=new e},1835:(a,b,c)=>{b.G7=f,b.iT=g,b.wW=h;let d=c(2220),e=(0,c(318).createLogger)("api-controller");async function f(a,b){if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{taskName:c,input:e}=a.body;if(!c||!e)return b.status(400).json({error:"taskName and input are required"});let f=await (0,d.startJob)({taskName:c,input:e});b.status(200).json(f)}catch(a){e.error("Start job API error",{error:a instanceof Error?a.message:"Unknown error"}),b.status(500).json({error:"Internal server error"})}}async function g(a,b){if("GET"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{jobId:c}=a.query;if(!c||"string"!=typeof c)return b.status(400).json({error:"jobId is required"});let e=await (0,d.getJobStatus)(c);b.status(200).json(e)}catch(a){if(a instanceof Error&&"Job not found"===a.message)return b.status(404).json({error:"Job not found"});e.error("Status job API error",{error:a instanceof Error?a.message:"Unknown error"}),b.status(500).json({error:"Internal server error"})}}async function h(a,b){if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{jobId:c}=a.body;if(!c)return b.status(400).json({error:"jobId is required"});let e=await (0,d.cancelJob)(c);b.status(200).json(e)}catch(a){if(a instanceof Error&&"Job not found"===a.message)return b.status(404).json({error:"Job not found"});e.error("Cancel job API error",{error:a instanceof Error?a.message:"Unknown error"}),b.status(500).json({error:"Internal server error"})}}},2220:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.jobs=void 0,b.startJob=n,b.getJobStatus=o,b.cancelJob=p;let d=c(5511),e=c(7031),f=c(318),g=c(2595),h=c(3667),i=c(4666),j=(0,f.createLogger)("api-dispatcher"),k=(0,g.createRateLimiter)(i.envConfig.get("rateLimit")),l=(0,h.createStorage)(i.envConfig.get("storage")),m=new Map;async function n(a){let{taskName:b,input:c}=a;if(!e.taskDispatcher.hasTask(b))throw Error(`Unknown task: ${b}`);let f=(0,d.randomUUID)(),g={id:f,taskName:b,input:c,status:"pending",progress:{completed:0,total:c.urls?.length||0,percentage:0,errors:0},result:null,error:null,startTime:new Date().toISOString(),endTime:null};return m.set(f,g),j.info("Job created",{jobId:f,taskName:b,urlCount:c.urls?.length||0}),q(f,b,c).catch(a=>{j.error("Job processing failed",{jobId:f,error:a.message});let b=m.get(f);b&&(b.status="failed",b.error=a.message,b.endTime=new Date().toISOString(),m.set(f,b))}),{jobId:f}}async function o(a){let b=m.get(a);if(!b)throw Error("Job not found");return{jobId:b.id,status:b.status,result:b.result,error:b.error,progress:b.progress}}async function p(a){let b=m.get(a);if(!b)throw Error("Job not found");return"completed"===b.status||"failed"===b.status?{success:!1}:(b.status="failed",b.error="Job cancelled by user",b.endTime=new Date().toISOString(),m.set(a,b),{success:!0})}async function q(a,b,c){let d=m.get(a);if(!d)throw Error("Job not found");try{d.status="running",m.set(a,d),j.info("Starting job processing",{jobId:a,taskName:b});let f={http:null,storage:l,logger:j,rateLimiter:k,config:i.envConfig.getAll(),jobId:a,correlationId:a},g=await e.taskDispatcher.execute(b,c,f);d.status="completed",d.result=g,d.endTime=new Date().toISOString(),d.progress={completed:g.summary?.total||0,total:g.summary?.total||0,percentage:100,errors:g.summary?.failed||0},m.set(a,d),j.info("Job completed successfully",{jobId:a,duration:Date.now()-new Date(d.startTime).getTime(),successful:g.summary?.successful||0,failed:g.summary?.failed||0})}catch(b){throw j.error("Job execution failed",{jobId:a,error:b instanceof Error?b.message:"Unknown error"}),d.status="failed",d.error=b instanceof Error?b.message:"Unknown error",d.endTime=new Date().toISOString(),m.set(a,d),b}}b.jobs=m},2595:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.RateLimiter=void 0,b.createRateLimiter=function(a){return new e({requestsPerMinute:60,burstLimit:10,windowMs:6e4,...a})};let d=c(318);class e{constructor(a){this.logger=(0,d.createLogger)("rate-limiter"),this.requests=[],this.burstCount=0,this.lastBurstReset=Date.now(),this.config={requestsPerMinute:60,burstLimit:10,windowMs:6e4,...a}}async schedule(a){return await this.waitForSlot(),a()}async waitForSlot(){let a=Date.now();if(this.requests=this.requests.filter(b=>a-b<this.config.windowMs),a-this.lastBurstReset>1e3&&(this.burstCount=0,this.lastBurstReset=a),this.burstCount>=this.config.burstLimit){let b=1e3-(a-this.lastBurstReset);if(b>0)return await this.sleep(b),this.waitForSlot()}if(this.requests.length>=this.config.requestsPerMinute){let b=Math.min(...this.requests),c=this.config.windowMs-(a-b);if(c>0)return await this.sleep(c),this.waitForSlot()}this.requests.push(a),this.burstCount++}sleep(a){return new Promise(b=>setTimeout(b,a))}getStatus(){let a=Date.now(),b=this.requests.filter(b=>a-b<this.config.windowMs).length,c=b<this.config.requestsPerMinute&&this.burstCount<this.config.burstLimit;return{requestsInWindow:b,burstCount:this.burstCount,canMakeRequest:c}}reset(){this.requests=[],this.burstCount=0,this.lastBurstReset=Date.now()}}b.RateLimiter=e},3667:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.DatabaseStorage=b.RedisStorage=b.MemoryStorage=b.Storage=void 0,b.createStorage=function(a){switch(a.type){case"memory":return new f;case"redis":return new g(a.config.redis);case"database":return new h(a.config.database);default:throw Error(`Unsupported storage type: ${a.type}`)}};let d=c(5586);class e{constructor(){this.logger=(0,d.createLogger)("storage")}}b.Storage=e;class f extends e{constructor(){super(...arguments),this.data=new Map}async get(a){let b=this.data.get(a);return b?b.expiresAt&&b.expiresAt<new Date?(this.data.delete(a),null):b.value:null}async set(a,b,c){let d=c?new Date(Date.now()+1e3*c):void 0;this.data.set(a,{value:b,expiresAt:d})}async delete(a){this.data.delete(a)}async exists(a){let b=this.data.get(a);return!!b&&(!(b.expiresAt&&b.expiresAt<new Date)||(this.data.delete(a),!1))}async clear(){this.data.clear()}async keys(a){let b=Array.from(this.data.keys());if(!a)return b;let c=new RegExp(a.replace(/\*/g,".*"));return b.filter(a=>c.test(a))}}b.MemoryStorage=f;class g extends e{constructor(a){super(),this.redis=a}async get(a){try{let b=await this.redis.get(a);return b?JSON.parse(b):null}catch(b){return this.logger.error("Redis get error",{key:a,error:b}),null}}async set(a,b,c){try{let d=JSON.stringify(b);c?await this.redis.setex(a,c,d):await this.redis.set(a,d)}catch(b){throw this.logger.error("Redis set error",{key:a,error:b}),b}}async delete(a){try{await this.redis.del(a)}catch(b){throw this.logger.error("Redis delete error",{key:a,error:b}),b}}async exists(a){try{let b=await this.redis.exists(a);return 1===b}catch(b){return this.logger.error("Redis exists error",{key:a,error:b}),!1}}async clear(){try{await this.redis.flushdb()}catch(a){throw this.logger.error("Redis clear error",{error:a}),a}}async keys(a){try{return await this.redis.keys(a||"*")}catch(b){return this.logger.error("Redis keys error",{pattern:a,error:b}),[]}}}b.RedisStorage=g;class h extends e{constructor(a){super(),this.db=a}async get(a){return null}async set(a,b,c){}async delete(a){}async exists(a){return!1}async clear(){}async keys(a){return[]}}b.DatabaseStorage=h},4666:(a,b)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.envConfig=b.defaultConfig=b.ConfigManager=void 0;class c{constructor(a){this.config={http:{timeout:3e4,maxRetries:3,userAgent:"Edge.Scraper.Pro/2.0.0"},rateLimit:{requestsPerMinute:60,burstLimit:10},storage:{type:"memory",config:{}},logging:{level:"info",format:"json"},...a}}get(a){return this.config[a]}set(a,b){this.config[a]=b}getAll(){return{...this.config}}static fromEnvironment(){let a={};return process.env.HTTP_TIMEOUT&&(a.http={...a.http,timeout:parseInt(process.env.HTTP_TIMEOUT,10),maxRetries:a.http?.maxRetries||3,userAgent:a.http?.userAgent||"Edge.Scraper.Pro/2.0.0"}),process.env.HTTP_MAX_RETRIES&&(a.http={...a.http,timeout:a.http?.timeout||3e4,maxRetries:parseInt(process.env.HTTP_MAX_RETRIES,10),userAgent:a.http?.userAgent||"Edge.Scraper.Pro/2.0.0"}),process.env.HTTP_USER_AGENT&&(a.http={...a.http,timeout:a.http?.timeout||3e4,maxRetries:a.http?.maxRetries||3,userAgent:process.env.HTTP_USER_AGENT}),process.env.RATE_LIMIT_RPM&&(a.rateLimit={...a.rateLimit,requestsPerMinute:parseInt(process.env.RATE_LIMIT_RPM,10),burstLimit:a.rateLimit?.burstLimit||10}),process.env.RATE_LIMIT_BURST&&(a.rateLimit={...a.rateLimit,requestsPerMinute:a.rateLimit?.requestsPerMinute||60,burstLimit:parseInt(process.env.RATE_LIMIT_BURST,10)}),process.env.STORAGE_TYPE&&(a.storage={type:process.env.STORAGE_TYPE,config:{}}),process.env.REDIS_URL&&(a.storage={type:"redis",config:{redis:{url:process.env.REDIS_URL}}}),process.env.LOG_LEVEL&&(a.logging={...a.logging,level:process.env.LOG_LEVEL}),process.env.LOG_FORMAT&&(a.logging={...a.logging,format:process.env.LOG_FORMAT}),new c(a)}validate(){let a=[];return this.config.http.timeout<1e3&&a.push("HTTP timeout must be at least 1000ms"),this.config.http.maxRetries<0&&a.push("HTTP max retries must be non-negative"),this.config.rateLimit.requestsPerMinute<1&&a.push("Rate limit requests per minute must be at least 1"),this.config.rateLimit.burstLimit<1&&a.push("Rate limit burst limit must be at least 1"),["memory","redis","database"].includes(this.config.storage.type)||a.push("Storage type must be one of: memory, redis, database"),["debug","info","warn","error"].includes(this.config.logging.level)||a.push("Log level must be one of: debug, info, warn, error"),["json","text"].includes(this.config.logging.format)||a.push("Log format must be one of: json, text"),{valid:0===a.length,errors:a}}}b.ConfigManager=c,b.defaultConfig=new c,b.envConfig=c.fromEnvironment()},5586:(a,b,c)=>{c.r(b),c.d(b,{TypedLogger:()=>g,createLogger:()=>i,logger:()=>h,replaceConsoleLog:()=>j});var d=c(4552),e=c.n(d),f=c(5511);class g{constructor(a={}){this.context=a.context||"app",this.correlationId=a.correlationId||(0,f.randomUUID)();let b={level:a.level||process.env.LOG_LEVEL||"info",redact:{paths:["req.headers.authorization","req.headers.cookie","password","token"],remove:!0},formatters:{level:a=>({level:a})}};this.logger=e()(b).child({correlationId:this.correlationId,context:this.context})}child(a){let b=new g({correlationId:this.correlationId,context:this.context});return b.logger=this.logger.child(a),b}trace(a,b){this.logger.trace(b,a)}debug(a,b){this.logger.debug(b,a)}info(a,b){this.logger.info(b,a)}warn(a,b){this.logger.warn(b,a)}error(a,b){this.logger.error(b,a)}fatal(a,b){this.logger.fatal(b,a)}log(a,b,c){this.logger[a](c,b)}getPinoLogger(){return this.logger}getCorrelationId(){return this.correlationId}getContext(){return this.context}}let h=new g,i=(a,b)=>new g({context:a,correlationId:b}),j=a=>{let b=i(a||"console-replacement"),c={log:console.log,info:console.info,warn:console.warn,error:console.error,debug:console.debug};return console.log=(a,...c)=>{b.info(a,{args:c})},console.info=(a,...c)=>{b.info(a,{args:c})},console.warn=(a,...c)=>{b.warn(a,{args:c})},console.error=(a,...c)=>{b.error(a,{args:c})},console.debug=(a,...c)=>{b.debug(a,{args:c})},()=>{Object.assign(console,c)}}},7031:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.taskDispatcher=b.TaskDispatcher=void 0,b.registerTask=function(a){b.taskDispatcher.register(a)},b.runTask=i,b.getTask=function(a){return b.taskDispatcher.getTask(a)},b.listTasks=function(){return b.taskDispatcher.listTasks()};let d=c(1569),e=c(9779),f=c(318),g=c(8273);class h{constructor(){this.tasks=new Map,this.logger=(0,f.createLogger)("task-dispatcher"),this.logger.info("Task dispatcher initialized")}register(a){if(!(0,e.isScrapeTask)(a))throw new e.TaskError("Invalid task contract","INVALID_TASK_CONTRACT",{task:a});this.tasks.has(a.name)&&this.logger.warn("Task already registered, updating",{taskName:a.name});let b={task:a,registered:new Date,usageCount:0,enabled:!0};this.tasks.set(a.name,b),this.logger.info("Task registered",{taskName:a.name,registered:b.registered.toISOString()})}unregister(a){let b=this.tasks.delete(a);return b&&this.logger.info("Task unregistered",{taskName:a}),b}getTask(a){let b=this.tasks.get(a);if(!b)throw new e.TaskNotFoundError(a);if(!b.enabled)throw new e.TaskError(`Task is disabled: ${a}`,"TASK_DISABLED",{taskName:a});return b.usageCount++,b.lastUsed=new Date,b.task}listTasks(){return Array.from(this.tasks.values()).map(a=>({name:a.task.name,enabled:a.enabled,usageCount:a.usageCount,lastUsed:a.lastUsed,registered:a.registered}))}getEnabledTasks(){return Array.from(this.tasks.values()).filter(a=>a.enabled).map(a=>a.task)}hasTask(a){return this.tasks.has(a)}setTaskEnabled(a,b){let c=this.tasks.get(a);if(!c)throw new e.TaskNotFoundError(a);c.enabled=b,this.logger.info("Task status changed",{taskName:a,enabled:b})}getStats(){let a=Array.from(this.tasks.values()),b=a.reduce((a,b)=>a+b.usageCount,0),c=a.reduce((a,b)=>b.usageCount>(a?.usageCount||0)?b:a,null);return{totalTasks:a.length,enabledTasks:a.filter(a=>a.enabled).length,disabledTasks:a.filter(a=>!a.enabled).length,totalUsage:b,mostUsedTask:c?.task.name}}async validateInput(a,b){let c=this.tasks.get(a);if(!c)throw new e.TaskNotFoundError(a);if(!c.enabled)throw new e.TaskError(`Task is disabled: ${a}`,"TASK_DISABLED",{taskName:a});let f=c.task;try{return f.input.parse(b),{valid:!0}}catch(a){if(a instanceof d.z.ZodError)return{valid:!1,errors:a.errors.map(a=>`${a.path.join(".")}: ${a.message}`)};return{valid:!1,errors:[a instanceof Error?a.message:"Unknown validation error"]}}}async execute(a,b,c){let d=this.tasks.get(a);if(!d)throw new e.TaskNotFoundError(a);if(!d.enabled)throw new e.TaskError(`Task is disabled: ${a}`,"TASK_DISABLED",{taskName:a});let f=d.task;this.logger.taskStart(a,{requestId:c.correlationId,jobId:c.jobId});try{let g=await this.validateInput(a,b);if(!g.valid)throw new e.TaskError("Input validation failed","VALIDATION_ERROR",{errors:g.errors});let h=Date.now(),i=await f.run(b,c),j=Date.now()-h;return f.output.parse(i),d.usageCount++,d.lastUsed=new Date,this.logger.taskComplete(a,{requestId:c.correlationId,jobId:c.jobId,duration_ms:j}),i}catch(d){let b=g.ErrorHandler.handle(d);throw this.logger.taskError(a,b,{requestId:c.correlationId,jobId:c.jobId}),b}}clear(){this.tasks.clear(),this.logger.info("Dispatcher cleared")}}async function i(a,c,d){return b.taskDispatcher.execute(a,c,d)}b.TaskDispatcher=h,b.taskDispatcher=new h},8273:(a,b)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.ErrorHandler=b.TimeoutError=b.ValidationError=b.StorageError=b.RateLimitError=b.HttpError=b.ConfigurationError=b.CoreError=void 0,b.createHttpError=function(a,b,c,d){return new e(a,b,c,d)},b.createRateLimitError=function(a,b,c){return new f(a,b,c)},b.createStorageError=function(a,b,c){return new g(a,b,c)},b.createValidationError=function(a,b,c){return new h(a,b,c)},b.createTimeoutError=function(a,b,c){return new i(a,b,c)};class c extends Error{constructor(a,b,c){super(a),this.code=b,this.details=c,this.name="CoreError"}}b.CoreError=c;class d extends c{constructor(a,b){super(a,"CONFIGURATION_ERROR",b),this.name="ConfigurationError"}}b.ConfigurationError=d;class e extends c{constructor(a,b,c,d){super(a,"HTTP_ERROR",{...d,status:b,url:c}),this.status=b,this.url=c,this.name="HttpError"}}b.HttpError=e;class f extends c{constructor(a,b,c){super(a,"RATE_LIMIT_ERROR",{...c,retryAfter:b}),this.retryAfter=b,this.name="RateLimitError"}}b.RateLimitError=f;class g extends c{constructor(a,b,c){super(a,"STORAGE_ERROR",{...c,operation:b}),this.operation=b,this.name="StorageError"}}b.StorageError=g;class h extends c{constructor(a,b,c){super(a,"VALIDATION_ERROR",{...c,validationErrors:b}),this.validationErrors=b,this.name="ValidationError"}}b.ValidationError=h;class i extends c{constructor(a,b,c){super(a,"TIMEOUT_ERROR",{...c,timeout:b}),this.timeout=b,this.name="TimeoutError"}}b.TimeoutError=i;class j{static handle(a){return a instanceof c?a:a instanceof Error?new c(a.message,"UNKNOWN_ERROR",{originalError:a.name,stack:a.stack}):new c("Unknown error occurred","UNKNOWN_ERROR",{originalError:String(a)})}static isRetryable(a){return["HTTP_ERROR","RATE_LIMIT_ERROR","TIMEOUT_ERROR","STORAGE_ERROR"].includes(a.code)}static getRetryDelay(a,b){return a instanceof f&&a.retryAfter?1e3*a.retryAfter:a instanceof e&&429===a.status?Math.min(1e3*Math.pow(2,b),3e4):a instanceof i?Math.min(1e3*Math.pow(2,b),1e4):Math.min(1e3*Math.pow(2,b),5e3)}static formatForLogging(a){return{name:a.name,message:a.message,code:a.code,details:a.details,stack:a.stack}}}b.ErrorHandler=j},9779:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),b.TaskNotFoundError=b.TaskExecutionError=b.TaskValidationError=b.TaskError=b.BatchOutputSchema=b.StandardOutputSchema=b.UrlListSchema=void 0,b.isScrapeTask=function(a){return a&&"string"==typeof a.name&&a.input&&a.output&&"function"==typeof a.run};let d=c(1569);b.UrlListSchema=d.z.object({urls:d.z.array(d.z.string().url()).min(1).max(1500),options:d.z.object({concurrency:d.z.number().min(1).max(20).optional().default(3),delayMs:d.z.number().min(0).max(1e4).optional().default(1e3),timeout:d.z.number().min(1e3).max(6e4).optional().default(3e4),maxRetries:d.z.number().min(0).max(5).optional().default(3)}).optional().default({})}),b.StandardOutputSchema=d.z.object({success:d.z.boolean(),data:d.z.any().optional(),error:d.z.string().optional(),metadata:d.z.object({url:d.z.string(),extractedAt:d.z.string(),processingTime:d.z.number(),task:d.z.string(),version:d.z.string()})}),b.BatchOutputSchema=d.z.object({results:d.z.array(b.StandardOutputSchema),summary:d.z.object({total:d.z.number(),successful:d.z.number(),failed:d.z.number(),averageTime:d.z.number(),errors:d.z.array(d.z.object({url:d.z.string(),error:d.z.string(),category:d.z.string()}))}),metadata:d.z.object({jobId:d.z.string(),task:d.z.string(),startTime:d.z.string(),endTime:d.z.string(),duration:d.z.number()})});class e extends Error{constructor(a,b,c){super(a),this.code=b,this.details=c,this.name="TaskError"}}b.TaskError=e;class f extends e{constructor(a,b){super(a,"VALIDATION_ERROR",{validationErrors:b}),this.validationErrors=b,this.name="TaskValidationError"}}b.TaskValidationError=f;class g extends e{constructor(a,b){super(a,"EXECUTION_ERROR",{originalError:b}),this.originalError=b,this.name="TaskExecutionError"}}b.TaskExecutionError=g;class h extends e{constructor(a){super(`Task not found: ${a}`,"TASK_NOT_FOUND",{taskName:a}),this.name="TaskNotFoundError"}}b.TaskNotFoundError=h}};